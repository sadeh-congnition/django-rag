<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="ROBOTS" content="ALL" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="Copyright" content="Django Software Foundation" />
    <meta name="keywords" content="Python, Django, framework, open-source" />
    <meta name="description" content="" />
    <meta name="fediverse:creator" content="@django@fosstodon.org" />
    
  
    
      
    
  
  <link rel="canonical" href="https://docs.djangoproject.com/en/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="el"
          href="https://docs.djangoproject.com/el/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="en"
          href="https://docs.djangoproject.com/en/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="es"
          href="https://docs.djangoproject.com/es/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="fr"
          href="https://docs.djangoproject.com/fr/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="id"
          href="https://docs.djangoproject.com/id/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="it"
          href="https://docs.djangoproject.com/it/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="ja"
          href="https://docs.djangoproject.com/ja/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="ko"
          href="https://docs.djangoproject.com/ko/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="pl"
          href="https://docs.djangoproject.com/pl/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="pt-br"
          href="https://docs.djangoproject.com/pt-br/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="sv"
          href="https://docs.djangoproject.com/sv/6.0/ref/models/expressions/">
  
    
      
    
    <link rel="alternate"
          hreflang="zh-hans"
          href="https://docs.djangoproject.com/zh-hans/6.0/ref/models/expressions/">
  

  <link rel="search"
        type="application/opensearchdescription+xml"
        href="https://docs.djangoproject.com/en/6.0/search/description/"
        title="Django documentation">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="https://static.djangoproject.com/img/icon-touch.e4872c4da341.png">
    <link rel="icon" sizes="192x192" href="https://static.djangoproject.com/img/icon-touch.e4872c4da341.png">
    <link rel="shortcut icon" href="https://static.djangoproject.com/img/favicon.6dbf28c0650e.ico">
    <meta name="msapplication-TileColor" content="#113228">
    <meta name="msapplication-TileImage" content="https://static.djangoproject.com/img/icon-tile.b01ac0ef9f67.png">
    <meta name="theme-color" content="#0C4B33">

    
      <meta property="og:title" content="Query Expressions | Django documentation" />
      <meta property="og:description" content="The web framework for perfectionists with deadlines." />
      <meta property="og:image" content="https://static.djangoproject.com/img/logos/django-logo-negative.1d528e2cb5fb.png" />
      <meta property="og:image:alt" content="Django logo" />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="546" />
      <meta property="og:image:type" content="image/png"/>
      <meta property="og:url" content="https://docs.djangoproject.com/en/6.0/ref/models/expressions/" />
      <meta property="og:site_name" content="Django Project" />

      <meta property="twitter:creator" content="djangoproject" />
      <meta property="twitter:site" content="djangoproject" />
      <meta property="twitter:card" content="summary">
    

    <title>Query Expressions | Django documentation | Django</title>

    <link rel="stylesheet" href="https://static.djangoproject.com/css/output.7f12b704d16e.css" >

    <script src="https://static.djangoproject.com/js/mod/switch-dark-mode.139625c684db.js"></script>
    
  </head>

  <body id="generic" class="">

    <a href="#main-content" class="skip-link">Skip to main content</a>
    

<header id="top">
  <div class="container container--flex--wrap--mobile">
    <a class="logo" href="https://www.djangoproject.com/">Django</a>
    <p class="meta">The web framework for perfectionists with deadlines.</p>
    <div class="header-mobile-only">
      
<search class="search form-input" aria-labelledby="docs-search-label">
  <form action="https://docs.djangoproject.com/en/6.0/search/">
    <label id="docs-search-label" class="visuallyhidden" for="id_q">Search</label>
    <input type="search" name="q" placeholder="Search" id="id_q">
    <input type="hidden" name="category" value="">

    <button type="submit">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span class="visuallyhidden">Submit</span>
    </button>
  </form>
</search>

      <div class="light-dark-mode-toggle">
        

<button class="theme-toggle">
  <div class="visually-hidden theme-label-when-auto">Toggle theme (current theme: auto)</div>
  <div class="visually-hidden theme-label-when-light">Toggle theme (current theme: light)</div>
  <div class="visually-hidden theme-label-when-dark">Toggle theme (current theme: dark)</div>

  <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
  <svg aria-hidden="true" class="theme-icon-when-auto">
    <use xlink:href="#icon-auto" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-dark">
    <use xlink:href="#icon-moon" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-light">
    <use xlink:href="#icon-sun" />
  </svg>
</button>

      </div>
    </div>
    <button class="menu-button">
      <i class="icon icon-reorder"></i>
      <span class="visuallyhidden">Menu</span>
    </button>
    <nav aria-labelledby="navigation-header">
      <span id="navigation-header" class="visuallyhidden">Main navigation</span>
      <ul>
        <li>
          <a href="https://www.djangoproject.com/start/overview/">Overview</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/download/">Download</a>
        </li>
        <li class="active">
          <a href="https://docs.djangoproject.com/">Documentation</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/weblog/">News</a>
        </li>
        <li>
          <a href="https://github.com/django/django" target="_blank" rel="noopener">Code</a>
        </li>
        <li>
          <a href="https://code.djangoproject.com/">Issues</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/community/">Community</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/foundation/">Foundation</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/fundraising/">&#9829; Donate</a>
        </li>
        <li>
          
<search class="search form-input" aria-labelledby="docs-search-label">
  <form action="https://docs.djangoproject.com/en/6.0/search/">
    <label id="docs-search-label" class="visuallyhidden" for="id_q">Search</label>
    <input type="search" name="q" placeholder="Search" id="id_q">
    <input type="hidden" name="category" value="">

    <button type="submit">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span class="visuallyhidden">Submit</span>
    </button>
  </form>
</search>

        </li>
        <li>
          

<button class="theme-toggle">
  <div class="visually-hidden theme-label-when-auto">Toggle theme (current theme: auto)</div>
  <div class="visually-hidden theme-label-when-light">Toggle theme (current theme: light)</div>
  <div class="visually-hidden theme-label-when-dark">Toggle theme (current theme: dark)</div>

  <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
  <svg aria-hidden="true" class="theme-icon-when-auto">
    <use xlink:href="#icon-auto" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-dark">
    <use xlink:href="#icon-moon" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-light">
    <use xlink:href="#icon-sun" />
  </svg>
</button>

        </li>
      </ul>
    </nav>
  </div>
</header>

    

    <section class="copy-banner">
      <div class="container 
  container--flex container--flex--wrap--mobile
">
        
  <p><a href="https://docs.djangoproject.com/en/6.0/">Documentation</a></p>

      </div>
    </section>

    <div id="billboard">
      
    </div>

    <div class="container sidebar-right">
      <main id="main-content">

        
          
        

        
  <div id="version-switcher">
    <ul id="faq-link">
      <li class="current-link">
        <a href="https://docs.djangoproject.com/en/6.0/faq/help/">
          <span>Getting Help</span>
        </a>
      </li>
    </ul>
    <ul id="doc-languages" class="language-switcher doc-switcher">
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/el/6.0/ref/models/expressions/">el</a>
          </li>
        
      
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/es/6.0/ref/models/expressions/">es</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/fr/6.0/ref/models/expressions/">fr</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/id/6.0/ref/models/expressions/">id</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/it/6.0/ref/models/expressions/">it</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/ja/6.0/ref/models/expressions/">ja</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/ko/6.0/ref/models/expressions/">ko</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/pl/6.0/ref/models/expressions/">pl</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/pt-br/6.0/ref/models/expressions/">pt-br</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/sv/6.0/ref/models/expressions/">sv</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/zh-hans/6.0/ref/models/expressions/">zh-hans</a>
          </li>
        
      
      <li class="current"
          title="Click on the links on the left to switch to another language.">
        <span>Language: <strong>en</strong></span>
      </li>
    </ul>

    
    <ul id="doc-versions" class="version-switcher doc-switcher">
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.8/ref/models/expressions/">1.8</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.10/ref/models/expressions/">1.10</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.11/ref/models/expressions/">1.11</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.0/ref/models/expressions/">2.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.1/ref/models/expressions/">2.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.2/ref/models/expressions/">2.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.0/ref/models/expressions/">3.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.1/ref/models/expressions/">3.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.2/ref/models/expressions/">3.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.0/ref/models/expressions/">4.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.1/ref/models/expressions/">4.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.2/ref/models/expressions/">4.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.0/ref/models/expressions/">5.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.1/ref/models/expressions/">5.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.2/ref/models/expressions/">5.2</a>
          </li>
        
      
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/dev/ref/models/expressions/">dev</a>
          </li>
        
      
      <li class="current"
          title="This document describes Django 6.0. Click on the links on the left to see other versions.">
        <span>Documentation version:
          <strong>6.0</strong>
        </span>
      </li>
    </ul>
    <ul id="backtotop-link">
      <li class="current-link">
        <a href="#top" aria-label="Back to top" class="icon-chevron-up-align"><i class="icon icon-chevron-up"></i></a>
      </li>
    </ul>
  </div>

  
    <article id="docs-content">
      <section id="s-query-expressions">
<span id="query-expressions"></span><h1>Query Expressions<a class="headerlink" href="#query-expressions" title="Link to this heading">¶</a></h1>
<p>Query expressions describe a value or a computation that can be used as part of
an update, create, filter, order by, annotation, or aggregate. When an
expression outputs a boolean value, it may be used directly in filters. There
are a number of built-in expressions (documented below) that can be used to
help you write queries. Expressions can be combined, or in some cases nested,
to form more complex computations.</p>
<section id="s-supported-arithmetic">
<span id="supported-arithmetic"></span><h2>Supported arithmetic<a class="headerlink" href="#supported-arithmetic" title="Link to this heading">¶</a></h2>
<p>Django supports negation, addition, subtraction, multiplication, division,
modulo arithmetic, and the power operator on query expressions, using Python
constants, variables, and even other expressions.</p>
</section>
<section id="s-output-field">
<span id="s-id1"></span><span id="output-field"></span><span id="id1"></span><h2>Output field<a class="headerlink" href="#output-field" title="Link to this heading">¶</a></h2>
<p>Many of the expressions documented in this section support an optional
<code class="docutils literal notranslate"><span class="pre">output_field</span></code> parameter. If given, Django will load the value into that
field after retrieving it from the database.</p>
<p><code class="docutils literal notranslate"><span class="pre">output_field</span></code> takes a model field instance, like <code class="docutils literal notranslate"><span class="pre">IntegerField()</span></code> or
<code class="docutils literal notranslate"><span class="pre">BooleanField()</span></code>. Usually, the field doesn’t need any arguments, like
<code class="docutils literal notranslate"><span class="pre">max_length</span></code>, since field arguments relate to data validation which will not
be performed on the expression’s output value.</p>
<p><code class="docutils literal notranslate"><span class="pre">output_field</span></code> is only required when Django is unable to automatically
determine the result’s field type, such as complex expressions that mix field
types. For example, adding a <code class="docutils literal notranslate"><span class="pre">DecimalField()</span></code> and a <code class="docutils literal notranslate"><span class="pre">FloatField()</span></code> requires
an output field, like <code class="docutils literal notranslate"><span class="pre">output_field=FloatField()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">output_field</span></code> also allows using custom fields that perform type conversions
outside a specific model field context. For example, if you frequently need to
perform date arithmetic with <code class="docutils literal notranslate"><span class="pre">timedelta</span></code>, you can create a custom field that
handles the conversion, ensuring consistent results across databases. See
<a class="reference internal" href="../../../howto/custom-model-fields/"><span class="doc">How to create custom model fields</span></a>.</p>
</section>
<section id="s-some-examples">
<span id="some-examples"></span><h2>Some examples<a class="headerlink" href="#some-examples" title="Link to this heading">¶</a></h2>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Value</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span><span class="p">,</span> <span class="n">Upper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">GreaterThan</span>

<span class="go"># Find companies that have more employees than chairs.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>

<span class="go"># Find companies that have at least twice as many employees</span>
<span class="go"># as chairs. Both the querysets below are equivalent.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>

<span class="go"># How many chairs are needed for each company to seat all employees?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">chairs_needed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">num_employees</span>
<span class="go">120</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">num_chairs</span>
<span class="go">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">chairs_needed</span>
<span class="go">70</span>

<span class="go"># Create a new company using expressions.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Google&quot;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="n">Upper</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;goog&quot;</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">ticker</span>
<span class="go">&#39;GOOG&#39;</span>

<span class="go"># Annotate models with an aggregated value. Both forms</span>
<span class="go"># below are equivalent.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_products</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_products</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)))</span>

<span class="go"># Aggregates can contain complex computations also</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_offerings</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;services&quot;</span><span class="p">)))</span>

<span class="go"># Expressions can also be used in order_by(), either directly</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Length</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Length</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="go"># or using the double underscore lookup syntax.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CharField</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">CharField</span><span class="o">.</span><span class="n">register_lookup</span><span class="p">(</span><span class="n">Length</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;name__length&quot;</span><span class="p">)</span>

<span class="go"># Boolean expression can be used directly in filters.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exists</span><span class="p">,</span> <span class="n">OuterRef</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">Exists</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">),</span> <span class="n">salary__gt</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">... </span><span class="p">)</span>

<span class="go"># Lookup expressions can also be used directly in filters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GreaterThan</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)))</span>
<span class="go"># or annotations.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">need_chairs</span><span class="o">=</span><span class="n">GreaterThan</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-built-in-expressions">
<span id="built-in-expressions"></span><h2>Built-in Expressions<a class="headerlink" href="#built-in-expressions" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These expressions are defined in <code class="docutils literal notranslate"><span class="pre">django.db.models.expressions</span></code> and
<code class="docutils literal notranslate"><span class="pre">django.db.models.aggregates</span></code>, but for convenience they’re available and
usually imported from <a class="reference internal" href="../../../topics/db/models/#module-django.db.models" title="django.db.models"><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.db.models</span></code></a>.</p>
</div>
<section id="s-f-expressions">
<span id="f-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions<a class="headerlink" href="#f-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.F">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">F</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L878"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.F" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>An <code class="docutils literal notranslate"><span class="pre">F()</span></code> object represents the value of a model field, transformed value of a
model field, or annotated column. It makes it possible to refer to model field
values and perform database operations using them without actually having to
pull them out of the database into Python memory.</p>
<p>Instead, Django uses the <code class="docutils literal notranslate"><span class="pre">F()</span></code> object to generate an SQL expression that
describes the required operation at the database level.</p>
<p>Let’s try this with an example. Normally, one might do something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tintin filed a news story!</span>
<span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Here, we have pulled the value of <code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code> from the database
into memory and manipulated it using familiar Python operators, and then saved
the object back to the database. But instead we could also have done:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Although <code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span> <span class="pre">=</span> <span class="pre">F('stories_filed')</span> <span class="pre">+</span> <span class="pre">1</span></code> looks like a
normal Python assignment of value to an instance attribute, in fact it’s an SQL
construct describing an operation on the database.</p>
<p>When Django encounters an instance of <code class="docutils literal notranslate"><span class="pre">F()</span></code>, it overrides the standard Python
operators to create an encapsulated SQL expression; in this case, one which
instructs the database to increment the database field represented by
<code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code>.</p>
<p>Whatever value is or was on <code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code>, Python never gets to
know about it - it is dealt with entirely by the database. All Python does,
through Django’s <code class="docutils literal notranslate"><span class="pre">F()</span></code> class, is create the SQL syntax to refer to the field
and describe the operation.</p>
<p>As well as being used in operations on single instances as above, <code class="docutils literal notranslate"><span class="pre">F()</span></code> can
be used with <code class="docutils literal notranslate"><span class="pre">update()</span></code> to perform bulk updates on a <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code>. This
reduces the two queries we were using above - the <code class="docutils literal notranslate"><span class="pre">get()</span></code> and the
<a class="reference internal" href="../instances/#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> - to just one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stories_filed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also use <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.update" title="django.db.models.query.QuerySet.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update()</span></code></a> to increment
the field value on multiple objects - which could be very much faster than
pulling them all into Python from the database, looping over them, incrementing
the field value of each one, and saving each one back to the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Reporter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stories_filed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> therefore can offer performance advantages by:</p>
<ul class="simple">
<li><p>getting the database, rather than Python, to do work</p></li>
<li><p>reducing the number of queries some operations require</p></li>
</ul>
<section id="s-slicing-f-expressions">
<span id="s-slicing-using-f"></span><span id="slicing-f-expressions"></span><span id="slicing-using-f"></span><h4>Slicing <code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions<a class="headerlink" href="#slicing-f-expressions" title="Link to this heading">¶</a></h4>
<p>For string-based fields, text-based fields, and
<a class="reference internal" href="../../contrib/postgres/fields/#django.contrib.postgres.fields.ArrayField" title="django.contrib.postgres.fields.ArrayField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayField</span></code></a>, you can use Python’s
array-slicing syntax. The indices are 0-based. The <code class="docutils literal notranslate"><span class="pre">step</span></code> argument to
<code class="docutils literal notranslate"><span class="pre">slice</span></code> and negative indexing are not supported. For example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Replacing a name with a substring of itself.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span> <span class="o">=</span> <span class="n">Writers</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Priyansh&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;riya&#39;</span>
</pre></div>
</div>
</section>
<section id="s-avoiding-race-conditions-using-f">
<span id="s-id2"></span><span id="avoiding-race-conditions-using-f"></span><span id="id2"></span><h4>Avoiding race conditions using <code class="docutils literal notranslate"><span class="pre">F()</span></code><a class="headerlink" href="#avoiding-race-conditions-using-f" title="Link to this heading">¶</a></h4>
<p>Another useful benefit of <code class="docutils literal notranslate"><span class="pre">F()</span></code> is that having the database - rather than
Python - update a field’s value avoids a <em>race condition</em>.</p>
<p>If two Python threads execute the code in the first example above, one thread
could retrieve, increment, and save a field’s value after the other has
retrieved it from the database. The value that the second thread saves will be
based on the original value; the work of the first thread will be lost.</p>
<p>If the database is responsible for updating the field, the process is more
robust: it will only ever update the field based on the value of the field in
the database when the <a class="reference internal" href="../instances/#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> or <code class="docutils literal notranslate"><span class="pre">update()</span></code> is executed, rather
than based on its value when the instance was retrieved.</p>
</section>
<section id="s-f-assignments-are-refreshed-after-model-save">
<span id="f-assignments-are-refreshed-after-model-save"></span><h4><code class="docutils literal notranslate"><span class="pre">F()</span></code> assignments are refreshed after <code class="docutils literal notranslate"><span class="pre">Model.save()</span></code><a class="headerlink" href="#f-assignments-are-refreshed-after-model-save" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> objects assigned to model fields are refreshed from the database on
<a class="reference internal" href="../instances/#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> on backends that support it without incurring a subsequent
query (SQLite, PostgreSQL, and Oracle) and deferred otherwise (MySQL or
MariaDB). For example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span>  <span class="c1"># This triggers a refresh query on MySQL/MariaDB.</span>
<span class="go">14  # Assuming the database value was 13 when the object was saved.</span>
</pre></div>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 6.0:</span> <p>In previous versions of Django, <code class="docutils literal notranslate"><span class="pre">F()</span></code> objects were not refreshed from the
database on <a class="reference internal" href="../instances/#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> which resulted in them being evaluated and
persisted every time the instance was saved.</p>
</div>
</section>
<section id="s-using-f-in-filters">
<span id="using-f-in-filters"></span><h4>Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> in filters<a class="headerlink" href="#using-f-in-filters" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> is also very useful in <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> filters, where they make it
possible to filter a set of objects against criteria based on their field
values, rather than on Python values.</p>
<p>This is documented in <a class="reference internal" href="../../../topics/db/queries/#using-f-expressions-in-filters"><span class="std std-ref">using F() expressions in queries</span></a>.</p>
</section>
<section id="s-using-f-with-annotations">
<span id="s-id3"></span><span id="using-f-with-annotations"></span><span id="id3"></span><h4>Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> with annotations<a class="headerlink" href="#using-f-with-annotations" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> can be used to create dynamic fields on your models by combining
different fields with arithmetic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">company</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">chairs_needed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>If the fields that you’re combining are of different types you’ll need to tell
Django what kind of field will be returned. Most expressions support
<a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> for this case, but since <code class="docutils literal notranslate"><span class="pre">F()</span></code> does not,
you will need to wrap the expression with <a class="reference internal" href="#django.db.models.ExpressionWrapper" title="django.db.models.ExpressionWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DateTimeField</span><span class="p">,</span> <span class="n">ExpressionWrapper</span><span class="p">,</span> <span class="n">F</span>

<span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">expires</span><span class="o">=</span><span class="n">ExpressionWrapper</span><span class="p">(</span>
        <span class="n">F</span><span class="p">(</span><span class="s2">&quot;active_at&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">),</span> <span class="n">output_field</span><span class="o">=</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When referencing relational fields such as <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code>, <code class="docutils literal notranslate"><span class="pre">F()</span></code> returns the
primary key value rather than a model instance:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">car</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">built_by</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;manufacturer&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">car</span><span class="o">.</span><span class="n">manufacturer</span>
<span class="go">&lt;Manufacturer: Toyota&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">car</span><span class="o">.</span><span class="n">built_by</span>
<span class="go">3</span>
</pre></div>
</div>
</section>
<section id="s-using-f-to-sort-null-values">
<span id="s-id4"></span><span id="using-f-to-sort-null-values"></span><span id="id4"></span><h4>Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> to sort null values<a class="headerlink" href="#using-f-to-sort-null-values" title="Link to this heading">¶</a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">F()</span></code> and the <code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> or <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> keyword argument to
<a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Expression.asc()</span></code></a> or <a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a> to control the ordering of
a field’s null values. By default, the ordering depends on your database.</p>
<p>For example, to sort companies that haven’t been contacted (<code class="docutils literal notranslate"><span class="pre">last_contacted</span></code>
is null) after companies that have been contacted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;last_contacted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="n">nulls_last</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="s-using-f-with-logical-operations">
<span id="using-f-with-logical-operations"></span><h4>Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> with logical operations<a class="headerlink" href="#using-f-with-logical-operations" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions that output <code class="docutils literal notranslate"><span class="pre">BooleanField</span></code> can be logically negated with
the inversion operator <code class="docutils literal notranslate"><span class="pre">~F()</span></code>. For example, to swap the activation status of
companies:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=~</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;is_active&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="s-func-expressions">
<span id="s-id5"></span><span id="func-expressions"></span><span id="id5"></span><h3><code class="docutils literal notranslate"><span class="pre">Func()</span></code> expressions<a class="headerlink" href="#func-expressions" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Func()</span></code> expressions are the base type of all expressions that involve
database functions like <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> and <code class="docutils literal notranslate"><span class="pre">LOWER</span></code>, or aggregates like <code class="docutils literal notranslate"><span class="pre">SUM</span></code>.
They can be used directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">Func</span>

<span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">field_lower</span><span class="o">=</span><span class="n">Func</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">),</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;LOWER&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>or they can be used to build a library of database functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Lower</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;LOWER&quot;</span>


<span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">field_lower</span><span class="o">=</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>But both cases will result in a queryset where each model is annotated with an
extra attribute <code class="docutils literal notranslate"><span class="pre">field_lower</span></code> produced, roughly, from the following SQL:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">LOWER</span><span class="p">(</span><span class="ss">&quot;db_table&quot;</span><span class="p">.</span><span class="ss">&quot;field&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;field_lower&quot;</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="../database-functions/"><span class="doc">Database Functions</span></a> for a list of built-in database
functions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Func</span></code> API is as follows:</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Func">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Func</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">expressions</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1050"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Func" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.function">
<span class="sig-name descname"><span class="pre">function</span></span><a class="headerlink" href="#django.db.models.Func.function" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute describing the function that will be generated.
Specifically, the <code class="docutils literal notranslate"><span class="pre">function</span></code> will be interpolated as the <code class="docutils literal notranslate"><span class="pre">function</span></code>
placeholder within <a class="reference internal" href="#django.db.models.Func.template" title="django.db.models.Func.template"><code class="xref py py-attr docutils literal notranslate"><span class="pre">template</span></code></a>. Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.Func.template" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute, as a format string, that describes the SQL that is
generated for this function. Defaults to
<code class="docutils literal notranslate"><span class="pre">'%(function)s(%(expressions)s)'</span></code>.</p>
<p>If you’re constructing SQL like <code class="docutils literal notranslate"><span class="pre">strftime('%W',</span> <span class="pre">'date')</span></code> and need a
literal <code class="docutils literal notranslate"><span class="pre">%</span></code> character in the query, quadruple it (<code class="docutils literal notranslate"><span class="pre">%%%%</span></code>) in the
<code class="docutils literal notranslate"><span class="pre">template</span></code> attribute because the string is interpolated twice: once
during the template interpolation in <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> and once in the SQL
interpolation with the query parameters in the database cursor.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.arg_joiner">
<span class="sig-name descname"><span class="pre">arg_joiner</span></span><a class="headerlink" href="#django.db.models.Func.arg_joiner" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute that denotes the character used to join the list of
<code class="docutils literal notranslate"><span class="pre">expressions</span></code> together. Defaults to <code class="docutils literal notranslate"><span class="pre">',</span> <span class="pre">'</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.arity">
<span class="sig-name descname"><span class="pre">arity</span></span><a class="headerlink" href="#django.db.models.Func.arity" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute that denotes the number of arguments the function
accepts. If this attribute is set and the function is called with a
different number of expressions, <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> will be raised. Defaults
to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Func.as_sql">
<span class="sig-name descname"><span class="pre">as_sql</span></span>(<em class="sig-param"><span class="n"><span class="pre">compiler</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">function</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">arg_joiner</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra_context</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1093"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Func.as_sql" title="Link to this definition">¶</a></dt>
<dd><p>Generates the SQL fragment for the database function. Returns a tuple
<code class="docutils literal notranslate"><span class="pre">(sql,</span> <span class="pre">params)</span></code>, where <code class="docutils literal notranslate"><span class="pre">sql</span></code> is the SQL string, and <code class="docutils literal notranslate"><span class="pre">params</span></code> is
the list or tuple of query parameters.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">as_vendor()</span></code> methods should use the <code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">template</span></code>,
<code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code>, and any other <code class="docutils literal notranslate"><span class="pre">**extra_context</span></code> parameters to
customize the SQL as needed. For example:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">django/db/models/functions.py</span></code></span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConcatPair</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;CONCAT&quot;</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_context</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span>
            <span class="n">compiler</span><span class="p">,</span>
            <span class="n">connection</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="s2">&quot;CONCAT_WS&quot;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(&#39;&#39;, </span><span class="si">%(expressions)s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">extra_context</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>To avoid an SQL injection vulnerability, <code class="docutils literal notranslate"><span class="pre">extra_context</span></code> <a class="reference internal" href="#avoiding-sql-injection-in-query-expressions"><span class="std std-ref">must
not contain untrusted user input</span></a> as these values are
interpolated into the SQL string rather than passed as query
parameters, where the database driver would escape them.</p>
</dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">*expressions</span></code> argument is a list of positional expressions that the
function will be applied to. The expressions will be converted to strings,
joined together with <code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code>, and then interpolated into the
<code class="docutils literal notranslate"><span class="pre">template</span></code> as the <code class="docutils literal notranslate"><span class="pre">expressions</span></code> placeholder.</p>
<p>Positional arguments can be expressions or Python values. Strings are
assumed to be column references and will be wrapped in <code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions
while other values will be wrapped in <code class="docutils literal notranslate"><span class="pre">Value()</span></code> expressions.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">**extra</span></code> kwargs are <code class="docutils literal notranslate"><span class="pre">key=value</span></code> pairs that can be interpolated
into the <code class="docutils literal notranslate"><span class="pre">template</span></code> attribute. To avoid an SQL injection vulnerability,
<code class="docutils literal notranslate"><span class="pre">extra</span></code> <a class="reference internal" href="#avoiding-sql-injection-in-query-expressions"><span class="std std-ref">must not contain untrusted user input</span></a> as these values are interpolated
into the SQL string rather than passed as query parameters, where the database
driver would escape them.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">template</span></code>, and <code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code> keywords can be used to
replace the attributes of the same name without having to define your own
class. <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> can be used to define the expected
return type.</p>
<div class="admonition-sanitize-input-used-to-configure-a-query-expression admonition">
<p class="admonition-title">Sanitize input used to configure a query expression</p>
<p>Built-in database functions (such as
<a class="reference internal" href="../database-functions/#django.db.models.functions.Cast" title="django.db.models.functions.Cast"><code class="xref py py-class docutils literal notranslate"><span class="pre">Cast</span></code></a>) vary in whether arguments such
as <code class="docutils literal notranslate"><span class="pre">output_field</span></code> can be supplied positionally or only by keyword. For
<code class="docutils literal notranslate"><span class="pre">output_field</span></code> and several other cases, the input ultimately reaches
<code class="docutils literal notranslate"><span class="pre">Func()</span></code> as a keyword argument, so the advice to avoid constructing
keyword arguments from untrusted user input applies as equally to these
arguments as it does to <code class="docutils literal notranslate"><span class="pre">**extra</span></code>.</p>
</div>
</section>
<section id="s-aggregate-expressions">
<span id="aggregate-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code> expressions<a class="headerlink" href="#aggregate-expressions" title="Link to this heading">¶</a></h3>
<p>An aggregate expression is a special case of a <a class="reference internal" href="#func-expressions"><span class="std std-ref">Func() expression</span></a> that informs the query that a <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> clause
is required. All of the <a class="reference internal" href="../querysets/#aggregation-functions"><span class="std std-ref">aggregate functions</span></a>,
like <code class="docutils literal notranslate"><span class="pre">Sum()</span></code> and <code class="docutils literal notranslate"><span class="pre">Count()</span></code>, inherit from <code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code>.</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code>s are expressions and wrap expressions, you can represent
some complex computations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">managers_required</span><span class="o">=</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">Count</span><span class="p">(</span><span class="s2">&quot;num_managers&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> API is as follows:</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Aggregate">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Aggregate</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">expressions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">distinct</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order_by</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/aggregates.py#L72"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Aggregate" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.Aggregate.template" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute, as a format string, that describes the SQL that is
generated for this aggregate. Defaults to
<code class="docutils literal notranslate"><span class="pre">'%(function)s(%(distinct)s%(expressions)s)'</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.function">
<span class="sig-name descname"><span class="pre">function</span></span><a class="headerlink" href="#django.db.models.Aggregate.function" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute describing the aggregate function that will be
generated. Specifically, the <code class="docutils literal notranslate"><span class="pre">function</span></code> will be interpolated as the
<code class="docutils literal notranslate"><span class="pre">function</span></code> placeholder within <a class="reference internal" href="#django.db.models.Aggregate.template" title="django.db.models.Aggregate.template"><code class="xref py py-attr docutils literal notranslate"><span class="pre">template</span></code></a>. Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.window_compatible">
<span class="sig-name descname"><span class="pre">window_compatible</span></span><a class="headerlink" href="#django.db.models.Aggregate.window_compatible" title="Link to this definition">¶</a></dt>
<dd><p>Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code> since most aggregate functions can be used as the
source expression in <a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.allow_distinct">
<span class="sig-name descname"><span class="pre">allow_distinct</span></span><a class="headerlink" href="#django.db.models.Aggregate.allow_distinct" title="Link to this definition">¶</a></dt>
<dd><p>A class attribute determining whether or not this aggregate function
allows passing a <code class="docutils literal notranslate"><span class="pre">distinct</span></code> keyword argument. If set to <code class="docutils literal notranslate"><span class="pre">False</span></code>
(default), <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> is raised if <code class="docutils literal notranslate"><span class="pre">distinct=True</span></code> is passed.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.allow_order_by">
<span class="sig-name descname"><span class="pre">allow_order_by</span></span><a class="headerlink" href="#django.db.models.Aggregate.allow_order_by" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 6.0.</span> </div>
<p>A class attribute determining whether or not this aggregate function
allows passing a <code class="docutils literal notranslate"><span class="pre">order_by</span></code> keyword argument. If set to <code class="docutils literal notranslate"><span class="pre">False</span></code>
(default), <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> is raised if <code class="docutils literal notranslate"><span class="pre">order_by</span></code> is passed as a value
other than <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.empty_result_set_value">
<span class="sig-name descname"><span class="pre">empty_result_set_value</span></span><a class="headerlink" href="#django.db.models.Aggregate.empty_result_set_value" title="Link to this definition">¶</a></dt>
<dd><p>Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> since most aggregate functions result in <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
when applied to an empty result set.</p>
</dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">expressions</span></code> positional arguments can include expressions, transforms of
the model field, or the names of model fields. They will be converted to a
string and used as the <code class="docutils literal notranslate"><span class="pre">expressions</span></code> placeholder within the <code class="docutils literal notranslate"><span class="pre">template</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">distinct</span></code> argument determines whether or not the aggregate function
should be invoked for each distinct value of <code class="docutils literal notranslate"><span class="pre">expressions</span></code> (or set of
values, for multiple <code class="docutils literal notranslate"><span class="pre">expressions</span></code>). The argument is only supported on
aggregates that have <a class="reference internal" href="#django.db.models.Aggregate.allow_distinct" title="django.db.models.Aggregate.allow_distinct"><code class="xref py py-attr docutils literal notranslate"><span class="pre">allow_distinct</span></code></a> set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">filter</span></code> argument takes a <a class="reference internal" href="../querysets/#django.db.models.Q" title="django.db.models.Q"><code class="xref py py-class docutils literal notranslate"><span class="pre">Q</span> <span class="pre">object</span></code></a> that’s
used to filter the rows that are aggregated. See <a class="reference internal" href="../conditional-expressions/#conditional-aggregation"><span class="std std-ref">Conditional aggregation</span></a>
and <a class="reference internal" href="../../../topics/db/aggregation/#filtering-on-annotations"><span class="std std-ref">Filtering on annotations</span></a> for example usage.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">order_by</span></code> argument behaves similarly to the <code class="docutils literal notranslate"><span class="pre">field_names</span></code> input of the
<a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">order_by()</span></code></a> function, accepting a field name (with an optional
<code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code> prefix which indicates descending order) or an expression (or a tuple
or list of strings and/or expressions) that specifies the ordering of the
elements in the result.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">default</span></code> argument takes a value that will be passed along with the
aggregate to <a class="reference internal" href="../database-functions/#django.db.models.functions.Coalesce" title="django.db.models.functions.Coalesce"><code class="xref py py-class docutils literal notranslate"><span class="pre">Coalesce</span></code></a>. This is useful for
specifying a value to be returned other than <code class="docutils literal notranslate"><span class="pre">None</span></code> when the queryset (or
grouping) contains no entries.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">**extra</span></code> kwargs are <code class="docutils literal notranslate"><span class="pre">key=value</span></code> pairs that can be interpolated
into the <code class="docutils literal notranslate"><span class="pre">template</span></code> attribute.</p>
<div class="versionchanged">
<span class="title">Changed in Django 6.0:</span> <p>The <code class="docutils literal notranslate"><span class="pre">order_by</span></code> argument was added.</p>
</div>
</section>
<section id="s-creating-your-own-aggregate-functions">
<span id="creating-your-own-aggregate-functions"></span><h3>Creating your own Aggregate Functions<a class="headerlink" href="#creating-your-own-aggregate-functions" title="Link to this heading">¶</a></h3>
<p>You can create your own aggregate functions, too. At a minimum, you need to
define <code class="docutils literal notranslate"><span class="pre">function</span></code>, but you can also completely customize the SQL that is
generated. Here’s a brief example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Aggregate</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Sum</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="c1"># Supports SUM(ALL field).</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;SUM&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(</span><span class="si">%(all_values)s%(expressions)s</span><span class="s2">)&quot;</span>
    <span class="n">allow_distinct</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">arity</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">all_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">all_values</span><span class="o">=</span><span class="s2">&quot;ALL &quot;</span> <span class="k">if</span> <span class="n">all_values</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-value-expressions">
<span id="value-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Value()</span></code> expressions<a class="headerlink" href="#value-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Value">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Value</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1144"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Value" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>A <code class="docutils literal notranslate"><span class="pre">Value()</span></code> object represents the smallest possible component of an
expression: a simple value. When you need to represent the value of an integer,
boolean, or string within an expression, you can wrap that value within a
<code class="docutils literal notranslate"><span class="pre">Value()</span></code>.</p>
<p>You will rarely need to use <code class="docutils literal notranslate"><span class="pre">Value()</span></code> directly. When you write the expression
<code class="docutils literal notranslate"><span class="pre">F('field')</span> <span class="pre">+</span> <span class="pre">1</span></code>, Django implicitly wraps the <code class="docutils literal notranslate"><span class="pre">1</span></code> in a <code class="docutils literal notranslate"><span class="pre">Value()</span></code>,
allowing simple values to be used in more complex expressions. You will need to
use <code class="docutils literal notranslate"><span class="pre">Value()</span></code> when you want to pass a string to an expression. Most
expressions interpret a string argument as the name of a field, like
<code class="docutils literal notranslate"><span class="pre">Lower('name')</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">value</span></code> argument describes the value to be included in the expression,
such as <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">True</span></code>, or <code class="docutils literal notranslate"><span class="pre">None</span></code>. Django knows how to convert these Python
values into their corresponding database type.</p>
<p>If no <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> is specified, it will be inferred from
the type of the provided <code class="docutils literal notranslate"><span class="pre">value</span></code> for many common types. For example, passing
an instance of <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.14)"><code class="xref py py-class docutils literal notranslate"><span class="pre">datetime.datetime</span></code></a> as <code class="docutils literal notranslate"><span class="pre">value</span></code> defaults
<code class="docutils literal notranslate"><span class="pre">output_field</span></code> to <a class="reference internal" href="../fields/#django.db.models.DateTimeField" title="django.db.models.DateTimeField"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTimeField</span></code></a>.</p>
</section>
<section id="s-expressionwrapper-expressions">
<span id="expressionwrapper-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper()</span></code> expressions<a class="headerlink" href="#expressionwrapper-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.ExpressionWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">ExpressionWrapper</span></span>(<em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1504"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.ExpressionWrapper" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code> surrounds another expression and provides access to
properties, such as <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a>, that may not be
available on other expressions. <code class="docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code> is necessary when using
arithmetic on <code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions with different types as described in
<a class="reference internal" href="#using-f-with-annotations"><span class="std std-ref">Using F() with annotations</span></a>.</p>
<div class="admonition-database-casting-not-performed admonition">
<p class="admonition-title">Database casting not performed</p>
<p><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code> only sets the output field for the ORM and does not
perform any database-level casting. To ensure a specific type is returned
from the database, use <a class="reference internal" href="../database-functions/#django.db.models.functions.Cast" title="django.db.models.functions.Cast"><code class="xref py py-class docutils literal notranslate"><span class="pre">Cast</span></code></a> instead.</p>
</div>
</section>
<section id="s-conditional-expressions">
<span id="conditional-expressions"></span><h3>Conditional expressions<a class="headerlink" href="#conditional-expressions" title="Link to this heading">¶</a></h3>
<p>Conditional expressions allow you to use <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.14)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">if</span></code></a> … <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#elif" title="(in Python v3.14)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">elif</span></code></a> …
<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#else" title="(in Python v3.14)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">else</span></code></a> logic in queries. Django natively supports SQL <code class="docutils literal notranslate"><span class="pre">CASE</span></code>
expressions. For more details see <a class="reference internal" href="../conditional-expressions/"><span class="doc">Conditional Expressions</span></a>.</p>
</section>
<section id="s-subquery-expressions">
<span id="subquery-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> expressions<a class="headerlink" href="#subquery-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Subquery">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Subquery</span></span>(<em class="sig-param"><span class="n"><span class="pre">queryset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1769"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Subquery" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>You can add an explicit subquery to a <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> using the <code class="docutils literal notranslate"><span class="pre">Subquery</span></code>
expression.</p>
<p>For example, to annotate each post with the email address of the author of the
newest comment on that post:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OuterRef</span><span class="p">,</span> <span class="n">Subquery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">newest</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">newest_commenter_email</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">newest</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<p>On PostgreSQL, the SQL looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;email&quot;</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;comment&quot;</span><span class="w"> </span><span class="n">U0</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;newest_commenter_email&quot;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;post&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples in this section are designed to show how to force
Django to execute a subquery. In some cases it may be possible to
write an equivalent queryset that performs the same task more
clearly or efficiently.</p>
</div>
<section id="s-referencing-columns-from-the-outer-queryset">
<span id="referencing-columns-from-the-outer-queryset"></span><h4>Referencing columns from the outer queryset<a class="headerlink" href="#referencing-columns-from-the-outer-queryset" title="Link to this heading">¶</a></h4>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.OuterRef">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">OuterRef</span></span>(<em class="sig-param"><span class="n"><span class="pre">field</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L979"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.OuterRef" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>Use <code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> when a queryset in a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> needs to refer to a field
from the outer query or its transform. It acts like an <a class="reference internal" href="#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span></code></a> expression
except that the check to see if it refers to a valid field isn’t made until the
outer queryset is resolved.</p>
<p>Instances of <code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> may be used in conjunction with nested instances
of <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> to refer to a containing queryset that isn’t the immediate
parent. For example, this queryset would need to be within a nested pair of
<code class="docutils literal notranslate"><span class="pre">Subquery</span></code> instances to resolve correctly:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</section>
<section id="s-limiting-a-subquery-to-a-single-column">
<span id="limiting-a-subquery-to-a-single-column"></span><h4>Limiting a subquery to a single column<a class="headerlink" href="#limiting-a-subquery-to-a-single-column" title="Link to this heading">¶</a></h4>
<p>There are times when a single column must be returned from a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code>, for
instance, to use a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> as the target of an <code class="docutils literal notranslate"><span class="pre">__in</span></code> lookup. To return
all comments for posts published within the last day:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one_day_ago</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published_at__gte</span><span class="o">=</span><span class="n">one_day_ago</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post__in</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>In this case, the subquery must use <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">values()</span></code></a>
to return only a single column: the primary key of the post.</p>
</section>
<section id="s-limiting-the-subquery-to-a-single-row">
<span id="limiting-the-subquery-to-a-single-row"></span><h4>Limiting the subquery to a single row<a class="headerlink" href="#limiting-the-subquery-to-a-single-row" title="Link to this heading">¶</a></h4>
<p>To prevent a subquery from returning multiple rows, a slice (<code class="docutils literal notranslate"><span class="pre">[:1]</span></code>) of the
queryset is used:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subquery</span> <span class="o">=</span> <span class="n">Subquery</span><span class="p">(</span><span class="n">newest</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">newest_commenter_email</span><span class="o">=</span><span class="n">subquery</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the subquery must only return a single column <em>and</em> a single
row: the email address of the most recently created comment.</p>
<p>(Using <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> instead of a slice would fail because the
<code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> cannot be resolved until the queryset is used within a
<code class="docutils literal notranslate"><span class="pre">Subquery</span></code>.)</p>
</section>
<section id="s-exists-subqueries">
<span id="exists-subqueries"></span><h4><code class="docutils literal notranslate"><span class="pre">Exists()</span></code> subqueries<a class="headerlink" href="#exists-subqueries" title="Link to this heading">¶</a></h4>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Exists">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Exists</span></span>(<em class="sig-param"><span class="n"><span class="pre">queryset</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1840"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Exists" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">Exists</span></code> is a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> subclass that uses an SQL <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> statement. In
many cases it will perform better than a subquery since the database is able to
stop evaluation of the subquery when a first matching row is found.</p>
<p>For example, to annotate each post with whether or not it has a comment from
within the last day:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exists</span><span class="p">,</span> <span class="n">OuterRef</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one_day_ago</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">recent_comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">created_at__gte</span><span class="o">=</span><span class="n">one_day_ago</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">recent_comment</span><span class="o">=</span><span class="n">Exists</span><span class="p">(</span><span class="n">recent_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>On PostgreSQL, the SQL looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;published_at&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;a&quot;</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;comment&quot;</span><span class="w"> </span><span class="n">U0</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span><span class="w"> </span><span class="n">HH</span><span class="p">:</span><span class="n">MM</span><span class="p">:</span><span class="n">SS</span><span class="w"> </span><span class="k">AND</span>
<span class="w">        </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;recent_comment&quot;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;post&quot;</span>
</pre></div>
</div>
<p>It’s unnecessary to force <code class="docutils literal notranslate"><span class="pre">Exists</span></code> to refer to a single column, since the
columns are discarded and a boolean result is returned. Similarly, since
ordering is unimportant within an SQL <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> subquery and would only
degrade performance, it’s automatically removed.</p>
<p>You can query using <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> with <code class="docutils literal notranslate"><span class="pre">~Exists()</span></code>.</p>
</section>
<section id="s-filtering-on-a-subquery-or-exists-expressions">
<span id="filtering-on-a-subquery-or-exists-expressions"></span><h4>Filtering on a <code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> or <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> expressions<a class="headerlink" href="#filtering-on-a-subquery-or-exists-expressions" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> that returns a boolean value and <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> may be used as a
<code class="docutils literal notranslate"><span class="pre">condition</span></code> in <a class="reference internal" href="../conditional-expressions/#django.db.models.expressions.When" title="django.db.models.expressions.When"><code class="xref py py-class docutils literal notranslate"><span class="pre">When</span></code></a> expressions, or to
directly filter a queryset:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">recent_comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># From above</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Exists</span><span class="p">(</span><span class="n">recent_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>This will ensure that the subquery will not be added to the <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> columns,
which may result in a better performance.</p>
</section>
<section id="s-using-aggregates-within-a-subquery-expression">
<span id="using-aggregates-within-a-subquery-expression"></span><h4>Using aggregates within a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> expression<a class="headerlink" href="#using-aggregates-within-a-subquery-expression" title="Link to this heading">¶</a></h4>
<p>Aggregates may be used within a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code>, but they require a specific
combination of <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">filter()</span></code></a>, <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">values()</span></code></a>, and
<a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">annotate()</span></code></a> to get the subquery grouping correct.</p>
<p>Assuming both models have a <code class="docutils literal notranslate"><span class="pre">length</span></code> field, to find posts where the post
length is greater than the total length of all combined comments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OuterRef</span><span class="p">,</span> <span class="n">Subquery</span><span class="p">,</span> <span class="n">Sum</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;post&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">total_comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">length__gt</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">total_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>The initial <code class="docutils literal notranslate"><span class="pre">filter(...)</span></code> limits the subquery to the relevant parameters.
<code class="docutils literal notranslate"><span class="pre">order_by()</span></code> removes the default <a class="reference internal" href="../options/#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ordering</span></code></a>
(if any) on the <code class="docutils literal notranslate"><span class="pre">Comment</span></code> model. <code class="docutils literal notranslate"><span class="pre">values('post')</span></code> aggregates comments by
<code class="docutils literal notranslate"><span class="pre">Post</span></code>. Finally, <code class="docutils literal notranslate"><span class="pre">annotate(...)</span></code> performs the aggregation. The order in
which these queryset methods are applied is important. In this case, since the
subquery must be limited to a single column, <code class="docutils literal notranslate"><span class="pre">values('total')</span></code> is required.</p>
<p>This is the only way to perform an aggregation within a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code>, as
using <a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.aggregate" title="django.db.models.query.QuerySet.aggregate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aggregate()</span></code></a> attempts to evaluate the queryset (and if
there is an <code class="docutils literal notranslate"><span class="pre">OuterRef</span></code>, this will not be possible to resolve).</p>
</section>
</section>
<section id="s-raw-sql-expressions">
<span id="raw-sql-expressions"></span><h3>Raw SQL expressions<a class="headerlink" href="#raw-sql-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.RawSQL">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">RawSQL</span></span>(<em class="sig-param"><span class="n"><span class="pre">sql</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">params</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1224"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.expressions.RawSQL" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>Sometimes database expressions can’t easily express a complex <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> clause.
In these edge cases, use the <code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> expression. For example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RawSQL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select col from sometable where othercol = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">,)))</span>
</pre></div>
</div>
<p>These extra lookups may not be portable to different database engines (because
you’re explicitly writing SQL code) and violate the DRY principle, so you
should avoid them if possible.</p>
<p><code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> expressions can also be used as the target of <code class="docutils literal notranslate"><span class="pre">__in</span></code> filters:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select id from sometable where col = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">,)))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>To protect against <a class="reference external" href="https://en.wikipedia.org/wiki/SQL_injection">SQL injection attacks</a>, you must escape any
parameters that the user can control by using <code class="docutils literal notranslate"><span class="pre">params</span></code>. <code class="docutils literal notranslate"><span class="pre">params</span></code> is a
required argument to force you to acknowledge that you’re not interpolating
your SQL with user-provided data.</p>
<p>You also must not quote placeholders in the SQL string. This example is
vulnerable to SQL injection because of the quotes around <code class="docutils literal notranslate"><span class="pre">%s</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select col from sometable where othercol = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>  <span class="c1"># unsafe!</span>
</pre></div>
</div>
<p>You can read more about how Django’s <a class="reference internal" href="../../../topics/security/#sql-injection-protection"><span class="std std-ref">SQL injection protection</span></a> works.</p>
</div>
</section>
<section id="s-window-functions">
<span id="window-functions"></span><h3>Window functions<a class="headerlink" href="#window-functions" title="Link to this heading">¶</a></h3>
<p>Window functions provide a way to apply functions on partitions. Unlike a
normal aggregation function which computes a final result for each set defined
by the group by, window functions operate on <a class="reference internal" href="#window-frames"><span class="std std-ref">frames</span></a> and
partitions, and compute the result for each row.</p>
<p>You can specify multiple windows in the same query which in Django ORM would be
equivalent to including multiple expressions in a <a class="reference internal" href="../../../topics/db/aggregation/"><span class="doc">QuerySet.annotate()</span></a> call. The ORM doesn’t make use of named windows,
instead they are part of the selected columns.</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.Window">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Window</span></span>(<em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition_by</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order_by</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">frame</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L1973"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.expressions.Window" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.Window.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.expressions.Window.template" title="Link to this definition">¶</a></dt>
<dd><p>Defaults to <code class="docutils literal notranslate"><span class="pre">%(expression)s</span> <span class="pre">OVER</span> <span class="pre">(%(window)s)</span></code>. If only the
<code class="docutils literal notranslate"><span class="pre">expression</span></code> argument is provided, the window clause will be blank.</p>
</dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">Window</span></code> class is the main expression for an <code class="docutils literal notranslate"><span class="pre">OVER</span></code> clause.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">expression</span></code> argument is either a <a class="reference internal" href="../database-functions/#window-functions"><span class="std std-ref">window function</span></a>, an <a class="reference internal" href="../querysets/#aggregation-functions"><span class="std std-ref">aggregate function</span></a>, or
an expression that’s compatible in a window clause.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">partition_by</span></code> argument accepts an expression or a sequence of
expressions (column names should be wrapped in an <code class="docutils literal notranslate"><span class="pre">F</span></code>-object) that control
the partitioning of the rows. Partitioning narrows which rows are used to
compute the result set.</p>
<p>The <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> is specified either as an argument or by
the expression.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">order_by</span></code> argument accepts an expression on which you can call
<a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">asc()</span></code></a> and
<a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a>, a string of a field name (with an
optional <code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code> prefix which indicates descending order), or a tuple or list
of strings and/or expressions. The ordering controls the order in which the
expression is applied. For example, if you sum over the rows in a partition,
the first result is the value of the first row, the second is the sum of first
and second row.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">frame</span></code> parameter specifies which other rows that should be used in the
computation. See <a class="reference internal" href="#window-frames"><span class="std std-ref">Frames</span></a> for details.</p>
<p>For example, to annotate each movie with the average rating for the movies by
the same studio in the same genre and release year:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>This allows you to check if a movie is rated better or worse than its peers.</p>
<p>You may want to apply multiple expressions over the same window, i.e., the
same partition and frame. For example, you could modify the previous example
to also include the best and worst rating in each movie’s group (same studio,
genre, and release year) by using three window functions in the same query. The
partition and ordering from the previous example is extracted into a dictionary
to reduce repetition:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">window</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;partition_by&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>    <span class="s2">&quot;order_by&quot;</span><span class="p">:</span> <span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">best</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">worst</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Min</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>Filtering against window functions is supported as long as lookups are not
disjunctive (not using <code class="docutils literal notranslate"><span class="pre">OR</span></code> or <code class="docutils literal notranslate"><span class="pre">XOR</span></code> as a connector) and against a queryset
performing aggregation.</p>
<p>For example, a query that relies on aggregation and has an <code class="docutils literal notranslate"><span class="pre">OR</span></code>-ed filter
against a window function and a field is not supported. Applying combined
predicates post-aggregation could cause rows that would normally be excluded
from groups to be included:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">category_rank</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span><span class="n">Rank</span><span class="p">(),</span> <span class="n">partition_by</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;-rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">scenes_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;actors&quot;</span><span class="p">),</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">category_rank__lte</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">title__contains</span><span class="o">=</span><span class="s2">&quot;Batman&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
<span class="go">NotImplementedError: Heterogeneous disjunctive predicates against window functions</span>
<span class="go">are not implemented when performing conditional aggregation.</span>
</pre></div>
</div>
<p>Among Django’s built-in database backends, MySQL, PostgreSQL, and Oracle
support window expressions. Support for different window expression features
varies among the different databases. For example, the options in
<a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">asc()</span></code></a> and
<a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a> may not be supported. Consult the
documentation for your database as needed.</p>
<section id="s-frames">
<span id="s-window-frames"></span><span id="frames"></span><span id="window-frames"></span><h4>Frames<a class="headerlink" href="#frames" title="Link to this heading">¶</a></h4>
<p>For a window frame, you can choose either a range-based sequence of rows or an
ordinary sequence of rows.</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.ValueRange">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">ValueRange</span></span>(<em class="sig-param"><span class="n"><span class="pre">start</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">end</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exclusion</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L2184"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.expressions.ValueRange" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.ValueRange.frame_type">
<span class="sig-name descname"><span class="pre">frame_type</span></span><a class="headerlink" href="#django.db.models.expressions.ValueRange.frame_type" title="Link to this definition">¶</a></dt>
<dd><p>This attribute is set to <code class="docutils literal notranslate"><span class="pre">'RANGE'</span></code>.</p>
</dd></dl>

<p>PostgreSQL has limited support for <code class="docutils literal notranslate"><span class="pre">ValueRange</span></code> and only supports use of
the standard start and end points, such as <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code> and <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span>
<span class="pre">FOLLOWING</span></code>.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.RowRange">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">RowRange</span></span>(<em class="sig-param"><span class="n"><span class="pre">start</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">end</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exclusion</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L2177"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.expressions.RowRange" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.RowRange.frame_type">
<span class="sig-name descname"><span class="pre">frame_type</span></span><a class="headerlink" href="#django.db.models.expressions.RowRange.frame_type" title="Link to this definition">¶</a></dt>
<dd><p>This attribute is set to <code class="docutils literal notranslate"><span class="pre">'ROWS'</span></code>.</p>
</dd></dl>

</dd></dl>

<p>Both classes return SQL with the template:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">start</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">end</span><span class="p">)</span><span class="n">s</span>
</pre></div>
</div>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">WindowFrameExclusion</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L2080"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW">
<span class="sig-name descname"><span class="pre">CURRENT_ROW</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.GROUP">
<span class="sig-name descname"><span class="pre">GROUP</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.GROUP" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.TIES">
<span class="sig-name descname"><span class="pre">TIES</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.TIES" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.NO_OTHERS">
<span class="sig-name descname"><span class="pre">NO_OTHERS</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.NO_OTHERS" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<p>The <code class="docutils literal notranslate"><span class="pre">exclusion</span></code> argument allows excluding rows
(<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW" title="django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW"><code class="xref py py-attr docutils literal notranslate"><span class="pre">CURRENT_ROW</span></code></a>), groups
(<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.GROUP" title="django.db.models.expressions.WindowFrameExclusion.GROUP"><code class="xref py py-attr docutils literal notranslate"><span class="pre">GROUP</span></code></a>), and ties
(<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.TIES" title="django.db.models.expressions.WindowFrameExclusion.TIES"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TIES</span></code></a>) from the window frames on supported
databases:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">start</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">end</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="n">EXCLUDE</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">exclusion</span><span class="p">)</span><span class="n">s</span>
</pre></div>
</div>
<p>Frames narrow the rows that are used for computing the result. They shift from
some start point to some specified end point. Frames can be used with and
without partitions, but it’s often a good idea to specify an ordering of the
window to ensure a deterministic result. In a frame, a peer in a frame is a row
with an equivalent value, or all rows if an ordering clause isn’t present.</p>
<p>The default starting point for a frame is <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code> which is the
first row of the partition. The end point is always explicitly included in the
SQL generated by the ORM and is by default <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code>. The default
frame includes all rows from the partition to the last row in the set.</p>
<p>The accepted values for the <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code> arguments are <code class="docutils literal notranslate"><span class="pre">None</span></code>, an
integer, or zero. A negative integer for <code class="docutils literal notranslate"><span class="pre">start</span></code> results in <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">PRECEDING</span></code>,
while <code class="docutils literal notranslate"><span class="pre">None</span></code> yields <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code>. In <code class="docutils literal notranslate"><span class="pre">ROWS</span></code> mode, a positive
integer can be used for <code class="docutils literal notranslate"><span class="pre">start</span></code> resulting in <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">FOLLOWING</span></code>. Positive
integers are accepted for <code class="docutils literal notranslate"><span class="pre">end</span></code> and results in <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">FOLLOWING</span></code>. In <code class="docutils literal notranslate"><span class="pre">ROWS</span></code>
mode, a negative integer can be used for <code class="docutils literal notranslate"><span class="pre">end</span></code> resulting in <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">PRECEDING</span></code>.
For both <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code>, zero will return <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code>.</p>
<p>There’s a difference in what <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code> includes. When specified in
<code class="docutils literal notranslate"><span class="pre">ROWS</span></code> mode, the frame starts or ends with the current row. When specified in
<code class="docutils literal notranslate"><span class="pre">RANGE</span></code> mode, the frame starts or ends at the first or last peer according to
the ordering clause. Thus, <code class="docutils literal notranslate"><span class="pre">RANGE</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code> evaluates the expression for
rows which have the same value specified by the ordering. Because the template
includes both the <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code> points, this may be expressed with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ValueRange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>If a movie’s “peers” are described as movies released by the same studio in the
same genre in the same year, this <code class="docutils literal notranslate"><span class="pre">RowRange</span></code> example annotates each movie
with the average rating of a movie’s two prior and two following peers:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">RowRange</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">frame</span><span class="o">=</span><span class="n">RowRange</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>If the database supports it, you can specify the start and end points based on
values of an expression in the partition. If the <code class="docutils literal notranslate"><span class="pre">released</span></code> field of the
<code class="docutils literal notranslate"><span class="pre">Movie</span></code> model stores the release month of each movie, this <code class="docutils literal notranslate"><span class="pre">ValueRange</span></code>
example annotates each movie with the average rating of a movie’s peers
released between twelve months before and twelve months after each movie:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">ValueRange</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">frame</span><span class="o">=</span><span class="n">ValueRange</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">12</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="s-technical-information">
<span id="technical-information"></span><h2>Technical Information<a class="headerlink" href="#technical-information" title="Link to this heading">¶</a></h2>
<p>Below you’ll find technical implementation details that may be useful to
library authors. The technical API and examples below will help with
creating generic query expressions that can extend the built-in functionality
that Django provides.</p>
<section id="s-expression-api">
<span id="expression-api"></span><h3>Expression API<a class="headerlink" href="#expression-api" title="Link to this heading">¶</a></h3>
<p>Query expressions implement the <a class="reference internal" href="../lookups/#query-expression"><span class="std std-ref">query expression API</span></a>,
but also expose a number of extra methods and attributes listed below. All
query expressions must inherit from <code class="docutils literal notranslate"><span class="pre">Expression()</span></code> or a relevant
subclass.</p>
<p>When a query expression wraps another expression, it is responsible for
calling the appropriate methods on the wrapped expression.</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Expression">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Expression</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/6.0.x/django/db/models/expressions.py#L520"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#django.db.models.Expression" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.allowed_default">
<span class="sig-name descname"><span class="pre">allowed_default</span></span><a class="headerlink" href="#django.db.models.Expression.allowed_default" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression can be used in
<a class="reference internal" href="../fields/#django.db.models.Field.db_default" title="django.db.models.Field.db_default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.db_default</span></code></a>. Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.constraint_validation_compatible">
<span class="sig-name descname"><span class="pre">constraint_validation_compatible</span></span><a class="headerlink" href="#django.db.models.Expression.constraint_validation_compatible" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression can be used during a constraint
validation. Expressions with <code class="docutils literal notranslate"><span class="pre">constraint_validation_compatible</span></code> set
to <code class="docutils literal notranslate"><span class="pre">False</span></code> must have only one source expression. Defaults to
<code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.contains_aggregate">
<span class="sig-name descname"><span class="pre">contains_aggregate</span></span><a class="headerlink" href="#django.db.models.Expression.contains_aggregate" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression contains an aggregate and that a
<code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> clause needs to be added to the query.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.contains_over_clause">
<span class="sig-name descname"><span class="pre">contains_over_clause</span></span><a class="headerlink" href="#django.db.models.Expression.contains_over_clause" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression contains a
<a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> expression. It’s used,
for example, to disallow window function expressions in queries that
modify data.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.filterable">
<span class="sig-name descname"><span class="pre">filterable</span></span><a class="headerlink" href="#django.db.models.Expression.filterable" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression can be referenced in
<a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QuerySet.filter()</span></code></a>. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.window_compatible">
<span class="sig-name descname"><span class="pre">window_compatible</span></span><a class="headerlink" href="#django.db.models.Expression.window_compatible" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django that this expression can be used as the source expression
in <a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a>. Defaults to
<code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.empty_result_set_value">
<span class="sig-name descname"><span class="pre">empty_result_set_value</span></span><a class="headerlink" href="#django.db.models.Expression.empty_result_set_value" title="Link to this definition">¶</a></dt>
<dd><p>Tells Django which value should be returned when the expression is used
to apply a function over an empty result set. Defaults to
<a class="reference external" href="https://docs.python.org/3/library/constants.html#NotImplemented" title="(in Python v3.14)"><code class="xref py py-data docutils literal notranslate"><span class="pre">NotImplemented</span></code></a> which forces the expression to be computed on
the database.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.set_returning">
<span class="sig-name descname"><span class="pre">set_returning</span></span><a class="headerlink" href="#django.db.models.Expression.set_returning" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.2.</span> </div>
<p>Tells Django that this expression contains a set-returning function,
enforcing subquery evaluation. It’s used, for example, to allow some
Postgres set-returning functions (e.g. <code class="docutils literal notranslate"><span class="pre">JSONB_PATH_QUERY</span></code>,
<code class="docutils literal notranslate"><span class="pre">UNNEST</span></code>, etc.) to skip optimization and be properly evaluated when
annotations spawn rows themselves. Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.allows_composite_expressions">
<span class="sig-name descname"><span class="pre">allows_composite_expressions</span></span><a class="headerlink" href="#django.db.models.Expression.allows_composite_expressions" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.2.</span> </div>
<p>Tells Django that this expression allows composite expressions, for
example, to support <a class="reference internal" href="../../../topics/composite-primary-key/#cpk-and-database-functions"><span class="std std-ref">composite primary keys</span></a>. Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.resolve_expression">
<span class="sig-name descname"><span class="pre">resolve_expression</span></span>(<em class="sig-param"><span class="n"><span class="pre">query</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_joins</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reuse</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">summarize</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">for_save</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.resolve_expression" title="Link to this definition">¶</a></dt>
<dd><p>Provides the chance to do any preprocessing or validation of
the expression before it’s added to the query. <code class="docutils literal notranslate"><span class="pre">resolve_expression()</span></code>
must also be called on any nested expressions. A <code class="docutils literal notranslate"><span class="pre">copy()</span></code> of <code class="docutils literal notranslate"><span class="pre">self</span></code>
should be returned with any necessary transformations.</p>
<p><code class="docutils literal notranslate"><span class="pre">query</span></code> is the backend query implementation.</p>
<p><code class="docutils literal notranslate"><span class="pre">allow_joins</span></code> is a boolean that allows or denies the use of
joins in the query.</p>
<p><code class="docutils literal notranslate"><span class="pre">reuse</span></code> is a set of reusable joins for multi-join scenarios.</p>
<p><code class="docutils literal notranslate"><span class="pre">summarize</span></code> is a boolean that, when <code class="docutils literal notranslate"><span class="pre">True</span></code>, signals that the
query being computed is a terminal aggregate query.</p>
<p><code class="docutils literal notranslate"><span class="pre">for_save</span></code> is a boolean that, when <code class="docutils literal notranslate"><span class="pre">True</span></code>, signals that the query
being executed is performing a create or update.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.get_source_expressions">
<span class="sig-name descname"><span class="pre">get_source_expressions</span></span>()<a class="headerlink" href="#django.db.models.Expression.get_source_expressions" title="Link to this definition">¶</a></dt>
<dd><p>Returns an ordered list of inner expressions. For example:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">()</span>
<span class="go">[F(&#39;foo&#39;)]</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.set_source_expressions">
<span class="sig-name descname"><span class="pre">set_source_expressions</span></span>(<em class="sig-param"><span class="n"><span class="pre">expressions</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.set_source_expressions" title="Link to this definition">¶</a></dt>
<dd><p>Takes a list of expressions and stores them such that
<code class="docutils literal notranslate"><span class="pre">get_source_expressions()</span></code> can return them.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.relabeled_clone">
<span class="sig-name descname"><span class="pre">relabeled_clone</span></span>(<em class="sig-param"><span class="n"><span class="pre">change_map</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.relabeled_clone" title="Link to this definition">¶</a></dt>
<dd><p>Returns a clone (copy) of <code class="docutils literal notranslate"><span class="pre">self</span></code>, with any column aliases relabeled.
Column aliases are renamed when subqueries are created.
<code class="docutils literal notranslate"><span class="pre">relabeled_clone()</span></code> should also be called on any nested expressions
and assigned to the clone.</p>
<p><code class="docutils literal notranslate"><span class="pre">change_map</span></code> is a dictionary mapping old aliases to new aliases.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">relabeled_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_map</span><span class="p">):</span>
    <span class="n">clone</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">clone</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clone</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.convert_value">
<span class="sig-name descname"><span class="pre">convert_value</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.convert_value" title="Link to this definition">¶</a></dt>
<dd><p>A hook allowing the expression to coerce <code class="docutils literal notranslate"><span class="pre">value</span></code> into a more
appropriate type.</p>
<p><code class="docutils literal notranslate"><span class="pre">expression</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">self</span></code>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.get_group_by_cols">
<span class="sig-name descname"><span class="pre">get_group_by_cols</span></span>()<a class="headerlink" href="#django.db.models.Expression.get_group_by_cols" title="Link to this definition">¶</a></dt>
<dd><p>Responsible for returning the list of columns references by
this expression. <code class="docutils literal notranslate"><span class="pre">get_group_by_cols()</span></code> should be called on any
nested expressions. <code class="docutils literal notranslate"><span class="pre">F()</span></code> objects, in particular, hold a reference
to a column.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.asc">
<span class="sig-name descname"><span class="pre">asc</span></span>(<em class="sig-param"><span class="n"><span class="pre">nulls_first</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nulls_last</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.asc" title="Link to this definition">¶</a></dt>
<dd><p>Returns the expression ready to be sorted in ascending order.</p>
<p><code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> and <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> define how null values are sorted.
See <a class="reference internal" href="#using-f-to-sort-null-values"><span class="std std-ref">Using F() to sort null values</span></a> for example usage.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.desc">
<span class="sig-name descname"><span class="pre">desc</span></span>(<em class="sig-param"><span class="n"><span class="pre">nulls_first</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nulls_last</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.desc" title="Link to this definition">¶</a></dt>
<dd><p>Returns the expression ready to be sorted in descending order.</p>
<p><code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> and <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> define how null values are sorted.
See <a class="reference internal" href="#using-f-to-sort-null-values"><span class="std std-ref">Using F() to sort null values</span></a> for example usage.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.reverse_ordering">
<span class="sig-name descname"><span class="pre">reverse_ordering</span></span>()<a class="headerlink" href="#django.db.models.Expression.reverse_ordering" title="Link to this definition">¶</a></dt>
<dd><p>Returns <code class="docutils literal notranslate"><span class="pre">self</span></code> with any modifications required to reverse the sort
order within an <code class="docutils literal notranslate"><span class="pre">order_by</span></code> call. As an example, an expression
implementing <code class="docutils literal notranslate"><span class="pre">NULLS</span> <span class="pre">LAST</span></code> would change its value to be
<code class="docutils literal notranslate"><span class="pre">NULLS</span> <span class="pre">FIRST</span></code>. Modifications are only required for expressions that
implement sort order like <code class="docutils literal notranslate"><span class="pre">OrderBy</span></code>. This method is called when
<a class="reference internal" href="../querysets/#django.db.models.query.QuerySet.reverse" title="django.db.models.query.QuerySet.reverse"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reverse()</span></code></a> is called on a
queryset.</p>
</dd></dl>

</dd></dl>

</section>
<section id="s-writing-your-own-query-expressions">
<span id="s-id6"></span><span id="writing-your-own-query-expressions"></span><span id="id6"></span><h3>Writing your own Query Expressions<a class="headerlink" href="#writing-your-own-query-expressions" title="Link to this heading">¶</a></h3>
<p>You can write your own query expression classes that use, and can integrate
with, other query expressions. Let’s step through an example by writing an
implementation of the <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> SQL function, without using the built-in
<a class="reference internal" href="#func-expressions"><span class="std std-ref">Func() expressions</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> SQL function is defined as taking a list of columns or
values. It will return the first column or value that isn’t <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p>We’ll start by defining the template to be used for SQL generation and
an <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method to set some attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Expression</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Coalesce</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;COALESCE( </span><span class="si">%(expressions)s</span><span class="s2"> )&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">output_field</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">output_field</span><span class="o">=</span><span class="n">output_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expressions must have at least 2 elements&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not an Expression&quot;</span> <span class="o">%</span> <span class="n">expression</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">expressions</span>
</pre></div>
</div>
<p>We do some basic validation on the parameters, including requiring at least 2
columns or values, and ensuring they are expressions. We are requiring
<a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> here so that Django knows what kind of model
field to assign the eventual result to.</p>
<p>Now we implement the preprocessing and validation. Since we do not have
any of our own validation at this point, we delegate to the nested
expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">resolve_expression</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_save</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">is_summary</span> <span class="o">=</span> <span class="n">summarize</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expressions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">allow_joins</span><span class="p">,</span> <span class="n">reuse</span><span class="p">,</span> <span class="n">summarize</span><span class="p">,</span> <span class="n">for_save</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
<p>Next, we write the method responsible for generating the SQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sql_expressions</span><span class="p">,</span> <span class="n">sql_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">:</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="n">sql_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">sql_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;expressions&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_expressions</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">data</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sql_params</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">as_oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example of vendor specific handling (Oracle in this case).</span>
<span class="sd">    Let&#39;s make the function name lowercase.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s2">&quot;coalesce( </span><span class="si">%(expressions)s</span><span class="s2"> )&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> methods can support custom keyword arguments, allowing
<code class="docutils literal notranslate"><span class="pre">as_vendorname()</span></code> methods to override data used to generate the SQL string.
Using <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> keyword arguments for customization is preferable to
mutating <code class="docutils literal notranslate"><span class="pre">self</span></code> within <code class="docutils literal notranslate"><span class="pre">as_vendorname()</span></code> methods as the latter can lead to
errors when running on different database backends. If your class relies on
class attributes to define data, consider allowing overrides in your
<code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> method.</p>
<p>We generate the SQL for each of the <code class="docutils literal notranslate"><span class="pre">expressions</span></code> by using the
<code class="docutils literal notranslate"><span class="pre">compiler.compile()</span></code> method, and join the result together with commas.
Then the template is filled out with our data and the SQL and parameters
are returned.</p>
<p>We’ve also defined a custom implementation that is specific to the Oracle
backend. The <code class="docutils literal notranslate"><span class="pre">as_oracle()</span></code> function will be called instead of <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code>
if the Oracle backend is in use.</p>
<p>Finally, we implement the rest of the methods that allow our query expression
to play nice with other query expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_source_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span>


<span class="k">def</span><span class="w"> </span><span class="nf">set_source_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">expressions</span>
</pre></div>
</div>
<p>Let’s see how it works:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">CharField</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">tagline</span><span class="o">=</span><span class="n">Coalesce</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;motto&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;ticker_name&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span> <span class="n">Value</span><span class="p">(</span><span class="s2">&quot;No Tagline&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">output_field</span><span class="o">=</span><span class="n">CharField</span><span class="p">(),</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tagline</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">Google: Do No Evil</span>
<span class="go">Apple: AAPL</span>
<span class="go">Yahoo: Internet Company</span>
<span class="go">Django Software Foundation: No Tagline</span>
</pre></div>
</div>
<section id="s-avoiding-sql-injection">
<span id="s-avoiding-sql-injection-in-query-expressions"></span><span id="avoiding-sql-injection"></span><span id="avoiding-sql-injection-in-query-expressions"></span><h4>Avoiding SQL injection<a class="headerlink" href="#avoiding-sql-injection" title="Link to this heading">¶</a></h4>
<p>Since a <code class="docutils literal notranslate"><span class="pre">Func</span></code>’s keyword arguments for <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>  (<code class="docutils literal notranslate"><span class="pre">**extra</span></code>) and
<code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> (<code class="docutils literal notranslate"><span class="pre">**extra_context</span></code>) are interpolated into the SQL string rather
than passed as query parameters (where the database driver would escape them),
they must not contain untrusted user input.</p>
<p>For example, if <code class="docutils literal notranslate"><span class="pre">substring</span></code> is user-provided, this function is vulnerable to
SQL injection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Func</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;POSITION&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(&#39;</span><span class="si">%(substring)s</span><span class="s2">&#39; in </span><span class="si">%(expressions)s</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="c1"># substring=substring is an SQL injection vulnerability!</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="o">=</span><span class="n">substring</span><span class="p">)</span>
</pre></div>
</div>
<p>This function generates an SQL string without any parameters. Since
<code class="docutils literal notranslate"><span class="pre">substring</span></code> is passed to <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code> as a keyword argument, it’s
interpolated into the SQL string before the query is sent to the database.</p>
<p>Here’s a corrected rewrite:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;POSITION&quot;</span>
    <span class="n">arg_joiner</span> <span class="o">=</span> <span class="s2">&quot; IN &quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">substring</span></code> instead passed as a positional argument, it’ll be passed as
a parameter in the database query.</p>
</section>
</section>
<section id="s-adding-support-in-third-party-database-backends">
<span id="adding-support-in-third-party-database-backends"></span><h3>Adding support in third-party database backends<a class="headerlink" href="#adding-support-in-third-party-database-backends" title="Link to this heading">¶</a></h3>
<p>If you’re using a database backend that uses a different SQL syntax for a
certain function, you can add support for it by monkey patching a new method
onto the function’s class.</p>
<p>Let’s say we’re writing a backend for Microsoft’s SQL Server which uses the SQL
<code class="docutils literal notranslate"><span class="pre">LEN</span></code> instead of <code class="docutils literal notranslate"><span class="pre">LENGTH</span></code> for the <a class="reference internal" href="../database-functions/#django.db.models.functions.Length" title="django.db.models.functions.Length"><code class="xref py py-class docutils literal notranslate"><span class="pre">Length</span></code></a> function.
We’ll monkey patch a new method called <code class="docutils literal notranslate"><span class="pre">as_sqlserver()</span></code> onto the <code class="docutils literal notranslate"><span class="pre">Length</span></code>
class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sqlserver_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;LEN&quot;</span><span class="p">)</span>


<span class="n">Length</span><span class="o">.</span><span class="n">as_sqlserver</span> <span class="o">=</span> <span class="n">sqlserver_length</span>
</pre></div>
</div>
<p>You can also customize the SQL using the <code class="docutils literal notranslate"><span class="pre">template</span></code> parameter of
<code class="docutils literal notranslate"><span class="pre">as_sql()</span></code>.</p>
<p>We use <code class="docutils literal notranslate"><span class="pre">as_sqlserver()</span></code> because <code class="docutils literal notranslate"><span class="pre">django.db.connection.vendor</span></code> returns
<code class="docutils literal notranslate"><span class="pre">sqlserver</span></code> for the backend.</p>
<p>Third-party backends can register their functions in the top level
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file of the backend package or in a top level
<code class="docutils literal notranslate"><span class="pre">expressions.py</span></code> file (or package) that is imported from the top level
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code>.</p>
<p>For user projects wishing to patch the backend that they’re using, this code
should live in an <a class="reference internal" href="../../applications/#django.apps.AppConfig.ready" title="django.apps.AppConfig.ready"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppConfig.ready()</span></code></a>
method.</p>
</section>
</section>
</section>

    </article>
  

  
    <nav class="browse-horizontal" aria-labelledby="browse-horizontal-header">
      <span id="browse-horizontal-header" class="visuallyhidden">Previous page and next page</span>
      
        <div class="left"><a rel="prev" href="../lookups/"><i class="icon icon-chevron-left"></i> Lookup API reference</a></div>
      
      
        <div class="right"><a rel="next" href="../conditional-expressions/">Conditional Expressions <i class="icon icon-chevron-right"></i></a></div>
      
    </nav>
  


        <a href="#top" class="backtotop"><i class="icon icon-chevron-up"></i> Back to Top</a>
      </main>

      
  <div role="complementary">
    <h2 class="visuallyhidden" id="aside-header">Additional Information</h2>

    


  <div class="fundraising-sidebar">
    <h3>Support Django!</h3>

    <div class="small-heart">
      <img src="https://static.djangoproject.com/img/fundraising-heart.cd6bb84ffd33.svg" alt="Support Django!" />
    </div>

    <div class="small-cta">
      <ul class="list-links-small">
        <li><a href="https://www.djangoproject.com/fundraising/">
          HappyHomeReports donated to the Django Software Foundation to support Django development. Donate today!
        </a></li>
      </ul>
    </div>
  </div>



    
      <h3>Contents</h3>
      
        <ul>
<li><a class="reference internal" href="#">Query Expressions</a><ul>
<li><a class="reference internal" href="#supported-arithmetic">Supported arithmetic</a></li>
<li><a class="reference internal" href="#output-field">Output field</a></li>
<li><a class="reference internal" href="#some-examples">Some examples</a></li>
<li><a class="reference internal" href="#built-in-expressions">Built-in Expressions</a><ul>
<li><a class="reference internal" href="#f-expressions"><code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions</a><ul>
<li><a class="reference internal" href="#slicing-f-expressions">Slicing <code class="docutils literal notranslate"><span class="pre">F()</span></code> expressions</a></li>
<li><a class="reference internal" href="#avoiding-race-conditions-using-f">Avoiding race conditions using <code class="docutils literal notranslate"><span class="pre">F()</span></code></a></li>
<li><a class="reference internal" href="#f-assignments-are-refreshed-after-model-save"><code class="docutils literal notranslate"><span class="pre">F()</span></code> assignments are refreshed after <code class="docutils literal notranslate"><span class="pre">Model.save()</span></code></a></li>
<li><a class="reference internal" href="#using-f-in-filters">Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> in filters</a></li>
<li><a class="reference internal" href="#using-f-with-annotations">Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> with annotations</a></li>
<li><a class="reference internal" href="#using-f-to-sort-null-values">Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> to sort null values</a></li>
<li><a class="reference internal" href="#using-f-with-logical-operations">Using <code class="docutils literal notranslate"><span class="pre">F()</span></code> with logical operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#func-expressions"><code class="docutils literal notranslate"><span class="pre">Func()</span></code> expressions</a></li>
<li><a class="reference internal" href="#aggregate-expressions"><code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code> expressions</a></li>
<li><a class="reference internal" href="#creating-your-own-aggregate-functions">Creating your own Aggregate Functions</a></li>
<li><a class="reference internal" href="#value-expressions"><code class="docutils literal notranslate"><span class="pre">Value()</span></code> expressions</a></li>
<li><a class="reference internal" href="#expressionwrapper-expressions"><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper()</span></code> expressions</a></li>
<li><a class="reference internal" href="#conditional-expressions">Conditional expressions</a></li>
<li><a class="reference internal" href="#subquery-expressions"><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> expressions</a><ul>
<li><a class="reference internal" href="#referencing-columns-from-the-outer-queryset">Referencing columns from the outer queryset</a></li>
<li><a class="reference internal" href="#limiting-a-subquery-to-a-single-column">Limiting a subquery to a single column</a></li>
<li><a class="reference internal" href="#limiting-the-subquery-to-a-single-row">Limiting the subquery to a single row</a></li>
<li><a class="reference internal" href="#exists-subqueries"><code class="docutils literal notranslate"><span class="pre">Exists()</span></code> subqueries</a></li>
<li><a class="reference internal" href="#filtering-on-a-subquery-or-exists-expressions">Filtering on a <code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> or <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> expressions</a></li>
<li><a class="reference internal" href="#using-aggregates-within-a-subquery-expression">Using aggregates within a <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> expression</a></li>
</ul>
</li>
<li><a class="reference internal" href="#raw-sql-expressions">Raw SQL expressions</a></li>
<li><a class="reference internal" href="#window-functions">Window functions</a><ul>
<li><a class="reference internal" href="#frames">Frames</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#technical-information">Technical Information</a><ul>
<li><a class="reference internal" href="#expression-api">Expression API</a></li>
<li><a class="reference internal" href="#writing-your-own-query-expressions">Writing your own Query Expressions</a><ul>
<li><a class="reference internal" href="#avoiding-sql-injection">Avoiding SQL injection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-support-in-third-party-database-backends">Adding support in third-party database backends</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      
    

    
      <nav aria-labelledby="browse-header">
        <h3 id="browse-header">Browse</h3>
        <ul>
          
            
              <li>Prev: <a rel="prev" href="../lookups/">Lookup API reference</a></li>
            
            
              <li>Next: <a rel="next" href="../conditional-expressions/">Conditional Expressions</a></li>
            
            <li><a href="https://docs.djangoproject.com/en/6.0/contents/">Table of contents</a></li>
            
              <li><a href="https://docs.djangoproject.com/en/6.0/genindex/">General Index</a></li>
            
              <li><a href="https://docs.djangoproject.com/en/6.0/py-modindex/">Python Module Index</a></li>
            
          
        </ul>
      </nav>
    

    
      <nav aria-labelledby="breadcrumbs-header">
        <h3 id="breadcrumbs-header">You are here:</h3>
        <ul>
          <li>
            <a href="https://docs.djangoproject.com/en/6.0/">Django 6.0 documentation</a>
            
              <ul><li><a href="../../">API Reference</a>
            
              <ul><li><a href="../">Models</a>
            
            <ul><li>Query Expressions</li></ul>
            </li></ul></li></ul>
          </li>
        </ul>
      </nav>
    

    
      <section aria-labelledby="getting-help-sidebar">
        <h3 id="getting-help-sidebar">Getting help</h3>
        <dl class="list-links">
          <dt><a href="https://docs.djangoproject.com/en/6.0/faq/">FAQ</a></dt>
          <dd>Try the FAQ — it's got answers to many common questions.</dd>

          <dt><a href="/en/stable/genindex/">Index</a>, <a href="/en/stable/py-modindex/">Module Index</a>, or <a href="/en/stable/contents/">Table of Contents</a></dt>
          <dd>Handy when looking for specific information.</dd>

          <dt><a href="https://chat.djangoproject.com">Django Discord Server</a></dt>
          <dd>Join the Django Discord Community.</dd>

          <dt><a href="https://forum.djangoproject.com/">Official Django Forum</a></dt>
          <dd>Join the community on the Django Forum.</dd>

          <dt><a href="https://code.djangoproject.com/">Ticket tracker</a></dt>
          <dd>Report bugs with Django or Django documentation in our ticket tracker.</dd>
        </dl>
      </section>
    

    
      <section aria-labelledby="links-wrapper-header">
        <h3 id="links-wrapper-header">Download:</h3>
        <p>
          Offline (Django 6.0):
          <a href="https://media.djangoproject.com/docs/django-docs-6.0-en.zip">HTML</a> |
          <a href="https://media.readthedocs.org/pdf/django/6.0.x/django.pdf">PDF</a> |
          <a href="https://media.readthedocs.org/epub/django/6.0.x/django.epub">ePub</a>
          <br>
          <span class="quiet">
            Provided by <a href="https://readthedocs.org/">Read the Docs</a>.
          </span>
        </p>
      </section>
    

    
  <div class="corporate-members">
    <h3>Diamond and Platinum Members</h3>
    
      <div class="clearfix">
        <div class="member-logo">
          <a href="https://sentry.io/for/django/" title="Sentry">
            <img src="https://media.djangoproject.com/cache/7a/f9/7af9c770dc49465739a82c91a0eb3d51.png" alt="Sentry" />
          </a>
        </div>
        <div class="small-cta">
          <ul class="list-links-small">
            <li><strong>Sentry</strong></li>
            <li><a href="https://sentry.io/for/django/" title="Sentry">
              Monitor your Django Code
Resolve performance bottlenecks and errors using monitoring, replays, logs and Seer an AI agent for debugging.
            </a></li>
          </ul>
        </div>
      </div>
    
      <div class="clearfix">
        <div class="member-logo">
          <a href="https://jb.gg/ybja10" title="JetBrains">
            <img src="https://media.djangoproject.com/cache/c0/ea/c0ea128467983e64aab91cd27e7918c0.png" alt="JetBrains" />
          </a>
        </div>
        <div class="small-cta">
          <ul class="list-links-small">
            <li><strong>JetBrains</strong></li>
            <li><a href="https://jb.gg/ybja10" title="JetBrains">
              JetBrains delivers intelligent software solutions that make developers more productive by simplifying their challenging tasks, automating the routine, and helping them adopt the best development practices. PyCharm is the Python IDE for Professional Developers by JetBrains providing a complete set of tools for productive Python, Web and scientific development.
            </a></li>
          </ul>
        </div>
      </div>
    
  </div>


  </div>

      

    </div>

     
     

    
    
    

    <!-- SVGs -->
    <svg xmlns="http://www.w3.org/2000/svg">
      <symbol viewBox="0 0 24 24" id="icon-auto"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2V4a8 8 0 1 0 0 16z"/></symbol>
      <symbol viewBox="0 0 24 24" id="icon-moon"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol>
      <symbol viewBox="0 0 24 24" id="icon-sun"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol>
    </svg>
    <!-- END SVGs -->

    
      

<footer>
  <div class="subfooter">
    <div class="container">
      <h2 class="visuallyhidden">Django Links</h2>
      <div class="column-container">
        <div class="col-learn-more">
          <h3>Learn More</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/start/overview/">About Django</a></li>
            
            <li><a href="https://www.djangoproject.com/start/">Getting Started with Django</a></li>
            <li><a href="https://www.djangoproject.com/foundation/teams/">Team Organization</a></li>
            <li><a href="https://www.djangoproject.com/foundation/">Django Software Foundation</a></li>
            <li><a href="https://www.djangoproject.com/conduct/">Code of Conduct</a></li>
            <li><a href="https://www.djangoproject.com/diversity/">Diversity Statement</a></li>
          </ul>
        </div>

        <div class="col-get-involved">
          <h3>Get Involved</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/community/">Join a Group</a></li>
            <li><a href="https://docs.djangoproject.com/en/dev/internals/contributing/">Contribute
              to Django</a></li>
            <li><a
              href="https://docs.djangoproject.com/en/dev/internals/contributing/bugs-and-features/">Submit
              a Bug</a></li>
            <li><a
              href="https://docs.djangoproject.com/en/dev/internals/security/#reporting-security-issues">Report
              a Security Issue</a></li>
            <li><a href="https://www.djangoproject.com/foundation/individual-members/">Individual membership</a></li>
          </ul>
        </div>

        <div class="col-get-help">
          <h3>Get Help</h3>
          <ul>
            <li><a href="https://docs.djangoproject.com/en/stable/faq/">Getting Help FAQ</a>
            </li>
            <li><a href="https://chat.djangoproject.com" target="_blank">Django Discord</a></li>
            <li><a href="https://forum.djangoproject.com/" target="_blank">Official Django Forum</a></li>
          </ul>
        </div>

        <div class="col-follow-us">
          <h3>Follow Us</h3>
          <ul>
            <li><a href="https://github.com/django">GitHub</a></li>
            <li><a href="https://x.com/djangoproject">X</a></li>
            <li><a href="https://fosstodon.org/@django" rel="me">Fediverse (Mastodon)</a></li>
            <li><a href="https://bsky.app/profile/djangoproject.com">Bluesky</a></li>
            <li><a href="https://www.linkedin.com/company/django-software-foundation">LinkedIn</a></li>
            <li><a href="https://www.djangoproject.com/rss/weblog/">News RSS</a></li>
          </ul>
        </div>

        <div class="col-support-us">
          <h3>Support Us</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/fundraising/">Sponsor Django</a></li>
            <li><a href="https://www.djangoproject.com/foundation/corporate-membership/">Corporate membership</a></li>
            <li><a href="https://django.threadless.com/" target="_blank">Official merchandise store</a></li>
            <li><a href="https://www.djangoproject.com/foundation/donate/#benevity-giving">Benevity Workplace Giving Program</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="container">
      <div class="footer-logo">
        <a class="logo" href="https://www.djangoproject.com/">Django</a>
      </div>
      <ul class="thanks">
        <li>
          <span>Hosting by</span> <a class="in-kind-donors" href="https://www.djangoproject.com/fundraising/#in-kind-donors">In-kind
            donors</a>
        </li>
        <li class="design"><span>Design by</span> <a class="threespot" href="https://www.threespot.com">Threespot</a>
          <span class="ampersand">&amp;</span> <a class="andrevv" href="http://andrevv.com/">andrevv</a></li>
      </ul>
      <p class="copyright">&copy; 2005-2025
        <a href="https://www.djangoproject.com/foundation/"> Django Software
          Foundation</a> and individual contributors. Django is a
        <a href="https://www.djangoproject.com/trademarks/">registered
          trademark</a> of the Django Software Foundation.
      </p>
    </div>
  </div>

</footer>

    

    
  


    
      
      <script>
        function extless(input) {
          return input.replace(/(.*)\.[^.]+$/, '$1');
        }
        var require = {
          shim: {
            'jquery': [],
            'stripe': {
              exports: 'Stripe'
            }
          },
          paths: {
            "jquery": extless("https://static.djangoproject.com/js/lib/jquery.min.5790ead7ad3b.js"),
            "mod/list-collapsing": extless("https://static.djangoproject.com/js/mod/list-collapsing.2d844151b2ec.js"),
            "mod/stripe-change-card": extless("https://static.djangoproject.com/js/mod/stripe-change-card.eaa0afc324e9.js"),
            "mod/switch-dark-mode": extless("https://static.djangoproject.com/js/mod/switch-dark-mode.139625c684db.js"),
            "stripe-checkout": "https://checkout.stripe.com/checkout",
            "stripe": "https://js.stripe.com/v3/?" // ? needed due to require.js
          }
        };
      </script>
      <script data-main="https://static.djangoproject.com/js/main.8677b21133eb.js" src="https://static.djangoproject.com/js/lib/require.177879fbe7dd.js"></script>
      <script src="https://static.djangoproject.com/js/djangoproject.15c016c8c3a7.js"></script>
    
  </body>
</html>
