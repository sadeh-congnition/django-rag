<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="ROBOTS" content="ALL" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="Copyright" content="Django Software Foundation" />
    <meta name="keywords" content="Python, Django, framework, open-source" />
    <meta name="description" content="" />
    <meta name="fediverse:creator" content="@django@fosstodon.org" />
    
  
    
      
    
  
  <link rel="canonical" href="https://docs.djangoproject.com/en/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="el"
          href="https://docs.djangoproject.com/el/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="en"
          href="https://docs.djangoproject.com/en/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="es"
          href="https://docs.djangoproject.com/es/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="fr"
          href="https://docs.djangoproject.com/fr/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="id"
          href="https://docs.djangoproject.com/id/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="it"
          href="https://docs.djangoproject.com/it/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="ja"
          href="https://docs.djangoproject.com/ja/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="ko"
          href="https://docs.djangoproject.com/ko/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="pl"
          href="https://docs.djangoproject.com/pl/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="pt-br"
          href="https://docs.djangoproject.com/pt-br/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="sv"
          href="https://docs.djangoproject.com/sv/6.0/topics/http/middleware/">
  
    
      
    
    <link rel="alternate"
          hreflang="zh-hans"
          href="https://docs.djangoproject.com/zh-hans/6.0/topics/http/middleware/">
  

  <link rel="search"
        type="application/opensearchdescription+xml"
        href="https://docs.djangoproject.com/en/6.0/search/description/"
        title="Django documentation">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="https://static.djangoproject.com/img/icon-touch.e4872c4da341.png">
    <link rel="icon" sizes="192x192" href="https://static.djangoproject.com/img/icon-touch.e4872c4da341.png">
    <link rel="shortcut icon" href="https://static.djangoproject.com/img/favicon.6dbf28c0650e.ico">
    <meta name="msapplication-TileColor" content="#113228">
    <meta name="msapplication-TileImage" content="https://static.djangoproject.com/img/icon-tile.b01ac0ef9f67.png">
    <meta name="theme-color" content="#0C4B33">

    
      <meta property="og:title" content="Middleware | Django documentation" />
      <meta property="og:description" content="The web framework for perfectionists with deadlines." />
      <meta property="og:image" content="https://static.djangoproject.com/img/logos/django-logo-negative.1d528e2cb5fb.png" />
      <meta property="og:image:alt" content="Django logo" />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="546" />
      <meta property="og:image:type" content="image/png"/>
      <meta property="og:url" content="https://docs.djangoproject.com/en/6.0/topics/http/middleware/" />
      <meta property="og:site_name" content="Django Project" />

      <meta property="twitter:creator" content="djangoproject" />
      <meta property="twitter:site" content="djangoproject" />
      <meta property="twitter:card" content="summary">
    

    <title>Middleware | Django documentation | Django</title>

    <link rel="stylesheet" href="https://static.djangoproject.com/css/output.7f12b704d16e.css" >

    <script src="https://static.djangoproject.com/js/mod/switch-dark-mode.139625c684db.js"></script>
    
  </head>

  <body id="generic" class="">

    <a href="#main-content" class="skip-link">Skip to main content</a>
    

<header id="top">
  <div class="container container--flex--wrap--mobile">
    <a class="logo" href="https://www.djangoproject.com/">Django</a>
    <p class="meta">The web framework for perfectionists with deadlines.</p>
    <div class="header-mobile-only">
      
<search class="search form-input" aria-labelledby="docs-search-label">
  <form action="https://docs.djangoproject.com/en/6.0/search/">
    <label id="docs-search-label" class="visuallyhidden" for="id_q">Search</label>
    <input type="search" name="q" placeholder="Search" id="id_q">
    <input type="hidden" name="category" value="">

    <button type="submit">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span class="visuallyhidden">Submit</span>
    </button>
  </form>
</search>

      <div class="light-dark-mode-toggle">
        

<button class="theme-toggle">
  <div class="visually-hidden theme-label-when-auto">Toggle theme (current theme: auto)</div>
  <div class="visually-hidden theme-label-when-light">Toggle theme (current theme: light)</div>
  <div class="visually-hidden theme-label-when-dark">Toggle theme (current theme: dark)</div>

  <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
  <svg aria-hidden="true" class="theme-icon-when-auto">
    <use xlink:href="#icon-auto" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-dark">
    <use xlink:href="#icon-moon" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-light">
    <use xlink:href="#icon-sun" />
  </svg>
</button>

      </div>
    </div>
    <button class="menu-button">
      <i class="icon icon-reorder"></i>
      <span class="visuallyhidden">Menu</span>
    </button>
    <nav aria-labelledby="navigation-header">
      <span id="navigation-header" class="visuallyhidden">Main navigation</span>
      <ul>
        <li>
          <a href="https://www.djangoproject.com/start/overview/">Overview</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/download/">Download</a>
        </li>
        <li class="active">
          <a href="https://docs.djangoproject.com/">Documentation</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/weblog/">News</a>
        </li>
        <li>
          <a href="https://github.com/django/django" target="_blank" rel="noopener">Code</a>
        </li>
        <li>
          <a href="https://code.djangoproject.com/">Issues</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/community/">Community</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/foundation/">Foundation</a>
        </li>
        <li>
          <a href="https://www.djangoproject.com/fundraising/">&#9829; Donate</a>
        </li>
        <li>
          
<search class="search form-input" aria-labelledby="docs-search-label">
  <form action="https://docs.djangoproject.com/en/6.0/search/">
    <label id="docs-search-label" class="visuallyhidden" for="id_q">Search</label>
    <input type="search" name="q" placeholder="Search" id="id_q">
    <input type="hidden" name="category" value="">

    <button type="submit">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span class="visuallyhidden">Submit</span>
    </button>
  </form>
</search>

        </li>
        <li>
          

<button class="theme-toggle">
  <div class="visually-hidden theme-label-when-auto">Toggle theme (current theme: auto)</div>
  <div class="visually-hidden theme-label-when-light">Toggle theme (current theme: light)</div>
  <div class="visually-hidden theme-label-when-dark">Toggle theme (current theme: dark)</div>

  <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
  <svg aria-hidden="true" class="theme-icon-when-auto">
    <use xlink:href="#icon-auto" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-dark">
    <use xlink:href="#icon-moon" />
  </svg>
  <svg aria-hidden="true" class="theme-icon-when-light">
    <use xlink:href="#icon-sun" />
  </svg>
</button>

        </li>
      </ul>
    </nav>
  </div>
</header>

    

    <section class="copy-banner">
      <div class="container 
  container--flex container--flex--wrap--mobile
">
        
  <p><a href="https://docs.djangoproject.com/en/6.0/">Documentation</a></p>

      </div>
    </section>

    <div id="billboard">
      
    </div>

    <div class="container sidebar-right">
      <main id="main-content">

        
          
        

        
  <div id="version-switcher">
    <ul id="faq-link">
      <li class="current-link">
        <a href="https://docs.djangoproject.com/en/6.0/faq/help/">
          <span>Getting Help</span>
        </a>
      </li>
    </ul>
    <ul id="doc-languages" class="language-switcher doc-switcher">
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/el/6.0/topics/http/middleware/">el</a>
          </li>
        
      
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/es/6.0/topics/http/middleware/">es</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/fr/6.0/topics/http/middleware/">fr</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/id/6.0/topics/http/middleware/">id</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/it/6.0/topics/http/middleware/">it</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/ja/6.0/topics/http/middleware/">ja</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/ko/6.0/topics/http/middleware/">ko</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/pl/6.0/topics/http/middleware/">pl</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/pt-br/6.0/topics/http/middleware/">pt-br</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/sv/6.0/topics/http/middleware/">sv</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/zh-hans/6.0/topics/http/middleware/">zh-hans</a>
          </li>
        
      
      <li class="current"
          title="Click on the links on the left to switch to another language.">
        <span>Language: <strong>en</strong></span>
      </li>
    </ul>

    
    <ul id="doc-versions" class="version-switcher doc-switcher">
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.8/topics/http/middleware/">1.8</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.10/topics/http/middleware/">1.10</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/1.11/topics/http/middleware/">1.11</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/">2.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.1/topics/http/middleware/">2.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/2.2/topics/http/middleware/">2.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.0/topics/http/middleware/">3.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.1/topics/http/middleware/">3.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/3.2/topics/http/middleware/">3.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.0/topics/http/middleware/">4.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.1/topics/http/middleware/">4.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/4.2/topics/http/middleware/">4.2</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.0/topics/http/middleware/">5.0</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.1/topics/http/middleware/">5.1</a>
          </li>
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/5.2/topics/http/middleware/">5.2</a>
          </li>
        
      
        
      
        
          <li class="other">
            
              
            
            <a href="https://docs.djangoproject.com/en/dev/topics/http/middleware/">dev</a>
          </li>
        
      
      <li class="current"
          title="This document describes Django 6.0. Click on the links on the left to see other versions.">
        <span>Documentation version:
          <strong>6.0</strong>
        </span>
      </li>
    </ul>
    <ul id="backtotop-link">
      <li class="current-link">
        <a href="#top" aria-label="Back to top" class="icon-chevron-up-align"><i class="icon icon-chevron-up"></i></a>
      </li>
    </ul>
  </div>

  
    <article id="docs-content">
      <section id="s-middleware">
<span id="middleware"></span><h1>Middleware<a class="headerlink" href="#middleware" title="Link to this heading">¶</a></h1>
<p>Middleware is a framework of hooks into Django’s request/response processing.
It’s a light, low-level “plugin” system for globally altering Django’s input
or output.</p>
<p>Each middleware component is responsible for doing some specific function. For
example, Django includes a middleware component,
<a class="reference internal" href="../../../ref/middleware/#django.contrib.auth.middleware.AuthenticationMiddleware" title="django.contrib.auth.middleware.AuthenticationMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">AuthenticationMiddleware</span></code></a>, that
associates users with requests using sessions.</p>
<p>This document explains how middleware works, how you activate middleware, and
how to write your own middleware. Django ships with some built-in middleware
you can use right out of the box. They’re documented in the <a class="reference internal" href="../../../ref/middleware/"><span class="doc">built-in
middleware reference</span></a>.</p>
<section id="s-writing-your-own-middleware">
<span id="writing-your-own-middleware"></span><h2>Writing your own middleware<a class="headerlink" href="#writing-your-own-middleware" title="Link to this heading">¶</a></h2>
<p>A middleware factory is a callable that takes a <code class="docutils literal notranslate"><span class="pre">get_response</span></code> callable and
returns a middleware. A middleware is a callable that takes a request and
returns a response, just like a view.</p>
<p>A middleware can be written as a function that looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simple_middleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
    <span class="c1"># One-time configuration and initialization.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
        <span class="c1"># Code to be executed for each request before</span>
        <span class="c1"># the view (and later middleware) are called.</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Code to be executed for each request/response after</span>
        <span class="c1"># the view is called.</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">return</span> <span class="n">middleware</span>
</pre></div>
</div>
<p>Or it can be written as a class whose instances are callable, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleMiddleware</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="c1"># One-time configuration and initialization.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Code to be executed for each request before</span>
        <span class="c1"># the view (and later middleware) are called.</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Code to be executed for each request/response after</span>
        <span class="c1"># the view is called.</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get_response</span></code> callable provided by Django might be the actual view (if
this is the last listed middleware) or it might be the next middleware in the
chain. The current middleware doesn’t need to know or care what exactly it is,
just that it represents whatever comes next.</p>
<p>The above is a slight simplification – the <code class="docutils literal notranslate"><span class="pre">get_response</span></code> callable for the
last middleware in the chain won’t be the actual view but rather a wrapper
method from the handler which takes care of applying <a class="reference internal" href="#view-middleware"><span class="std std-ref">view middleware</span></a>, calling the view with appropriate URL arguments, and
applying <a class="reference internal" href="#template-response-middleware"><span class="std std-ref">template-response</span></a> and
<a class="reference internal" href="#exception-middleware"><span class="std std-ref">exception</span></a> middleware.</p>
<p>Middleware can either support only synchronous Python (the default), only
asynchronous Python, or both. See <a class="reference internal" href="#async-middleware"><span class="std std-ref">Asynchronous support</span></a> for details of how to
advertise what you support, and know what kind of request you are getting.</p>
<p>Middleware can live anywhere on your Python path.</p>
<section id="s-init-get-response">
<span id="init-get-response"></span><h3><code class="docutils literal notranslate"><span class="pre">__init__(get_response)</span></code><a class="headerlink" href="#init-get-response" title="Link to this heading">¶</a></h3>
<p>Middleware factories must accept a <code class="docutils literal notranslate"><span class="pre">get_response</span></code> argument. You can also
initialize some global state for the middleware. Keep in mind a couple of
caveats:</p>
<ul class="simple">
<li><p>Django initializes your middleware with only the <code class="docutils literal notranslate"><span class="pre">get_response</span></code> argument,
so you can’t define <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> as requiring any other arguments.</p></li>
<li><p>Unlike the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method which is called once per request,
<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> is called only <em>once</em>, when the web server starts.</p></li>
</ul>
</section>
<section id="s-marking-middleware-as-unused">
<span id="marking-middleware-as-unused"></span><h3>Marking middleware as unused<a class="headerlink" href="#marking-middleware-as-unused" title="Link to this heading">¶</a></h3>
<p>It’s sometimes useful to determine at startup time whether a piece of
middleware should be used. In these cases, your middleware’s <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>
method may raise <a class="reference internal" href="../../../ref/exceptions/#django.core.exceptions.MiddlewareNotUsed" title="django.core.exceptions.MiddlewareNotUsed"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MiddlewareNotUsed</span></code></a>. Django will
then remove that middleware from the middleware process and log a debug message
to the <a class="reference internal" href="../../../ref/logging/#django-request-logger"><span class="std std-ref">django.request</span></a> logger when <a class="reference internal" href="../../../ref/settings/#std-setting-DEBUG"><code class="xref std std-setting docutils literal notranslate"><span class="pre">DEBUG</span></code></a> is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</section>
</section>
<section id="s-activating-middleware">
<span id="activating-middleware"></span><h2>Activating middleware<a class="headerlink" href="#activating-middleware" title="Link to this heading">¶</a></h2>
<p>To activate a middleware component, add it to the <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> list in
your Django settings.</p>
<p>In <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>, each middleware component is represented by a string:
the full Python path to the middleware factory’s class or function name. For
example, here’s the default value created by <a class="reference internal" href="../../../ref/django-admin/#django-admin-startproject"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">django-admin</span>
<span class="pre">startproject</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;django.middleware.security.SecurityMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.contrib.sessions.middleware.SessionMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.middleware.common.CommonMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.middleware.csrf.CsrfViewMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.contrib.auth.middleware.AuthenticationMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.contrib.messages.middleware.MessageMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.middleware.clickjacking.XFrameOptionsMiddleware&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<p>A Django installation doesn’t require any middleware — <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>
can be empty, if you’d like — but it’s strongly suggested that you at least use
<a class="reference internal" href="../../../ref/middleware/#django.middleware.common.CommonMiddleware" title="django.middleware.common.CommonMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">CommonMiddleware</span></code></a>.</p>
<p>The order in <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> matters because a middleware can depend on
other middleware. For instance,
<a class="reference internal" href="../../../ref/middleware/#django.contrib.auth.middleware.AuthenticationMiddleware" title="django.contrib.auth.middleware.AuthenticationMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">AuthenticationMiddleware</span></code></a> stores the
authenticated user in the session; therefore, it must run after
<a class="reference internal" href="../../../ref/middleware/#django.contrib.sessions.middleware.SessionMiddleware" title="django.contrib.sessions.middleware.SessionMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">SessionMiddleware</span></code></a>. See
<a class="reference internal" href="../../../ref/middleware/#middleware-ordering"><span class="std std-ref">Middleware ordering</span></a> for some common hints about ordering of Django
middleware classes.</p>
</section>
<section id="s-middleware-order-and-layering">
<span id="middleware-order-and-layering"></span><h2>Middleware order and layering<a class="headerlink" href="#middleware-order-and-layering" title="Link to this heading">¶</a></h2>
<p>During the request phase, before calling the view, Django applies middleware in
the order it’s defined in <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>, top-down.</p>
<p>You can think of it like an onion: each middleware class is a “layer” that
wraps the view, which is in the core of the onion. If the request passes
through all the layers of the onion (each one calls <code class="docutils literal notranslate"><span class="pre">get_response</span></code> to pass
the request in to the next layer), all the way to the view at the core, the
response will then pass through every layer (in reverse order) on the way back
out.</p>
<p>If one of the layers decides to short-circuit and return a response without
ever calling its <code class="docutils literal notranslate"><span class="pre">get_response</span></code>, none of the layers of the onion inside that
layer (including the view) will see the request or the response. The response
will only return through the same layers that the request passed in through.</p>
</section>
<section id="s-other-middleware-hooks">
<span id="other-middleware-hooks"></span><h2>Other middleware hooks<a class="headerlink" href="#other-middleware-hooks" title="Link to this heading">¶</a></h2>
<p>Besides the basic request/response middleware pattern described earlier, you
can add three other special methods to class-based middleware:</p>
<section id="s-process-view">
<span id="s-view-middleware"></span><span id="process-view"></span><span id="view-middleware"></span><h3><code class="docutils literal notranslate"><span class="pre">process_view()</span></code><a class="headerlink" href="#process-view" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="process_view">
<span class="sig-name descname"><span class="pre">process_view</span></span>(<em class="sig-param"><span class="n"><span class="pre">request</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">view_func</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">view_args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">view_kwargs</span></span></em>)<a class="headerlink" href="#process_view" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">request</span></code> is an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> object. <code class="docutils literal notranslate"><span class="pre">view_func</span></code> is
the Python function that Django is about to use. (It’s the actual function
object, not the name of the function as a string.) <code class="docutils literal notranslate"><span class="pre">view_args</span></code> is a list of
positional arguments that will be passed to the view, and <code class="docutils literal notranslate"><span class="pre">view_kwargs</span></code> is a
dictionary of keyword arguments that will be passed to the view. Neither
<code class="docutils literal notranslate"><span class="pre">view_args</span></code> nor <code class="docutils literal notranslate"><span class="pre">view_kwargs</span></code> include the first view argument
(<code class="docutils literal notranslate"><span class="pre">request</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">process_view()</span></code> is called just before Django calls the view.</p>
<p>It should return either <code class="docutils literal notranslate"><span class="pre">None</span></code> or an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a>
object. If it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>, Django will continue processing this request,
executing any other <code class="docutils literal notranslate"><span class="pre">process_view()</span></code> middleware and, then, the appropriate
view. If it returns an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> object, Django won’t
bother calling the appropriate view; it’ll apply response middleware to that
<a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> and return the result.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Accessing <a class="reference internal" href="../../../ref/request-response/#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> inside
middleware before the view runs or in <code class="docutils literal notranslate"><span class="pre">process_view()</span></code> will prevent any
view running after the middleware from being able to <a class="reference internal" href="../file-uploads/#modifying-upload-handlers-on-the-fly"><span class="std std-ref">modify the
upload handlers for the request</span></a>,
and should normally be avoided.</p>
<p>The <a class="reference internal" href="../../../ref/middleware/#django.middleware.csrf.CsrfViewMiddleware" title="django.middleware.csrf.CsrfViewMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">CsrfViewMiddleware</span></code></a> class can be
considered an exception, as it provides the
<a class="reference internal" href="../../../ref/csrf/#django.views.decorators.csrf.csrf_exempt" title="django.views.decorators.csrf.csrf_exempt"><code class="xref py py-func docutils literal notranslate"><span class="pre">csrf_exempt()</span></code></a> and
<a class="reference internal" href="../../../ref/csrf/#django.views.decorators.csrf.csrf_protect" title="django.views.decorators.csrf.csrf_protect"><code class="xref py py-func docutils literal notranslate"><span class="pre">csrf_protect()</span></code></a> decorators which allow
views to explicitly control at what point the CSRF validation should occur.</p>
</div>
</section>
<section id="s-process-exception">
<span id="s-exception-middleware"></span><span id="process-exception"></span><span id="exception-middleware"></span><h3><code class="docutils literal notranslate"><span class="pre">process_exception()</span></code><a class="headerlink" href="#process-exception" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="process_exception">
<span class="sig-name descname"><span class="pre">process_exception</span></span>(<em class="sig-param"><span class="n"><span class="pre">request</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exception</span></span></em>)<a class="headerlink" href="#process_exception" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">request</span></code> is an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> object. <code class="docutils literal notranslate"><span class="pre">exception</span></code> is an
<code class="docutils literal notranslate"><span class="pre">Exception</span></code> object raised by the view function.</p>
<p>Django calls <code class="docutils literal notranslate"><span class="pre">process_exception()</span></code> when a view raises an exception.
<code class="docutils literal notranslate"><span class="pre">process_exception()</span></code> should return either <code class="docutils literal notranslate"><span class="pre">None</span></code> or an
<a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> object. If it returns an
<a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> object, the template response and response
middleware will be applied and the resulting response returned to the
browser. Otherwise, <a class="reference internal" href="../../../ref/views/#error-views"><span class="std std-ref">default exception handling</span></a> kicks in.</p>
<p>Again, middleware are run in reverse order during the response phase, which
includes <code class="docutils literal notranslate"><span class="pre">process_exception</span></code>. If an exception middleware returns a response,
the <code class="docutils literal notranslate"><span class="pre">process_exception</span></code> methods of the middleware classes above that
middleware won’t be called at all.</p>
</section>
<section id="s-process-template-response">
<span id="s-template-response-middleware"></span><span id="process-template-response"></span><span id="template-response-middleware"></span><h3><code class="docutils literal notranslate"><span class="pre">process_template_response()</span></code><a class="headerlink" href="#process-template-response" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="process_template_response">
<span class="sig-name descname"><span class="pre">process_template_response</span></span>(<em class="sig-param"><span class="n"><span class="pre">request</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">response</span></span></em>)<a class="headerlink" href="#process_template_response" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">request</span></code> is an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> object. <code class="docutils literal notranslate"><span class="pre">response</span></code> is
the <a class="reference internal" href="../../../ref/template-response/#django.template.response.TemplateResponse" title="django.template.response.TemplateResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">TemplateResponse</span></code></a> object (or equivalent)
returned by a Django view or by a middleware.</p>
<p><code class="docutils literal notranslate"><span class="pre">process_template_response()</span></code> is called just after the view has finished
executing, if the response instance has a <code class="docutils literal notranslate"><span class="pre">render()</span></code> method, indicating that
it is a <a class="reference internal" href="../../../ref/template-response/#django.template.response.TemplateResponse" title="django.template.response.TemplateResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">TemplateResponse</span></code></a> or equivalent.</p>
<p>It must return a response object that implements a <code class="docutils literal notranslate"><span class="pre">render</span></code> method. It could
alter the given <code class="docutils literal notranslate"><span class="pre">response</span></code> by changing <code class="docutils literal notranslate"><span class="pre">response.template_name</span></code> and
<code class="docutils literal notranslate"><span class="pre">response.context_data</span></code>, or it could create and return a brand-new
<a class="reference internal" href="../../../ref/template-response/#django.template.response.TemplateResponse" title="django.template.response.TemplateResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">TemplateResponse</span></code></a> or equivalent.</p>
<p>You don’t need to explicitly render responses – responses will be
automatically rendered once all template response middleware has been
called.</p>
<p>Middleware are run in reverse order during the response phase, which
includes <code class="docutils literal notranslate"><span class="pre">process_template_response()</span></code>.</p>
</section>
</section>
<section id="s-dealing-with-streaming-responses">
<span id="dealing-with-streaming-responses"></span><h2>Dealing with streaming responses<a class="headerlink" href="#dealing-with-streaming-responses" title="Link to this heading">¶</a></h2>
<p>Unlike <a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a>,
<a class="reference internal" href="../../../ref/request-response/#django.http.StreamingHttpResponse" title="django.http.StreamingHttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamingHttpResponse</span></code></a> does not have a <code class="docutils literal notranslate"><span class="pre">content</span></code>
attribute. As a result, middleware can no longer assume that all responses
will have a <code class="docutils literal notranslate"><span class="pre">content</span></code> attribute. If they need access to the content, they
must test for streaming responses and adjust their behavior accordingly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
    <span class="n">response</span><span class="o">.</span><span class="n">streaming_content</span> <span class="o">=</span> <span class="n">wrap_streaming_content</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">streaming_content</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">alter_content</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">streaming_content</span></code> should be assumed to be too large to hold in memory.
Response middleware may wrap it in a new generator, but must not consume
it. Wrapping is typically implemented as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">wrap_streaming_content</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">content</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">alter_content</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><a class="reference internal" href="../../../ref/request-response/#django.http.StreamingHttpResponse" title="django.http.StreamingHttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">StreamingHttpResponse</span></code></a> allows both synchronous and
asynchronous iterators. The wrapping function must match. Check
<a class="reference internal" href="../../../ref/request-response/#django.http.StreamingHttpResponse.is_async" title="django.http.StreamingHttpResponse.is_async"><code class="xref py py-attr docutils literal notranslate"><span class="pre">StreamingHttpResponse.is_async</span></code></a> if your middleware needs to
support both types of iterator.</p>
</section>
<section id="s-exception-handling">
<span id="exception-handling"></span><h2>Exception handling<a class="headerlink" href="#exception-handling" title="Link to this heading">¶</a></h2>
<p>Django automatically converts exceptions raised by the view or by middleware
into an appropriate HTTP response with an error status code. <a class="reference internal" href="../../../ref/views/#error-views"><span class="std std-ref">Certain
exceptions</span></a> are converted to 4xx status codes, while an unknown
exception is converted to a 500 status code.</p>
<p>This conversion takes place before and after each middleware (you can think of
it as the thin film in between each layer of the onion), so that every
middleware can always rely on getting some kind of HTTP response back from
calling its <code class="docutils literal notranslate"><span class="pre">get_response</span></code> callable. Middleware don’t need to worry about
wrapping their call to <code class="docutils literal notranslate"><span class="pre">get_response</span></code> in a <code class="docutils literal notranslate"><span class="pre">try/except</span></code> and handling an
exception that might have been raised by a later middleware or the view. Even
if the very next middleware in the chain raises an
<a class="reference internal" href="../views/#django.http.Http404" title="django.http.Http404"><code class="xref py py-class docutils literal notranslate"><span class="pre">Http404</span></code></a> exception, for example, your middleware won’t see
that exception; instead it will get an <a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a>
object with a <a class="reference internal" href="../../../ref/request-response/#django.http.HttpResponse.status_code" title="django.http.HttpResponse.status_code"><code class="xref py py-attr docutils literal notranslate"><span class="pre">status_code</span></code></a> of 404.</p>
<p>You can set <a class="reference internal" href="../../../ref/settings/#std-setting-DEBUG_PROPAGATE_EXCEPTIONS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">DEBUG_PROPAGATE_EXCEPTIONS</span></code></a> to <code class="docutils literal notranslate"><span class="pre">True</span></code> to skip this
conversion and propagate exceptions upward.</p>
</section>
<section id="s-asynchronous-support">
<span id="s-async-middleware"></span><span id="asynchronous-support"></span><span id="async-middleware"></span><h2>Asynchronous support<a class="headerlink" href="#asynchronous-support" title="Link to this heading">¶</a></h2>
<p>Middleware can support any combination of synchronous and asynchronous
requests. Django will adapt requests to fit the middleware’s requirements if it
cannot support both, but at a performance penalty.</p>
<p>By default, Django assumes that your middleware is capable of handling only
synchronous requests. To change these assumptions, set the following attributes
on your middleware factory function or class:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sync_capable</span></code> is a boolean indicating if the middleware can handle
synchronous requests. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">async_capable</span></code> is a boolean indicating if the middleware can handle
asynchronous requests. Defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ul>
<p>If your middleware has both <code class="docutils literal notranslate"><span class="pre">sync_capable</span> <span class="pre">=</span> <span class="pre">True</span></code> and
<code class="docutils literal notranslate"><span class="pre">async_capable</span> <span class="pre">=</span> <span class="pre">True</span></code>, then Django will pass it the request without
converting it. In this case, you can work out if your middleware will receive
async requests by checking if the <code class="docutils literal notranslate"><span class="pre">get_response</span></code> object you are passed is a
coroutine function, using <code class="docutils literal notranslate"><span class="pre">asgiref.sync.iscoroutinefunction</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">django.utils.decorators</span></code> module contains
<a class="reference internal" href="../../../ref/utils/#django.utils.decorators.sync_only_middleware" title="django.utils.decorators.sync_only_middleware"><code class="xref py py-func docutils literal notranslate"><span class="pre">sync_only_middleware()</span></code></a>,
<a class="reference internal" href="../../../ref/utils/#django.utils.decorators.async_only_middleware" title="django.utils.decorators.async_only_middleware"><code class="xref py py-func docutils literal notranslate"><span class="pre">async_only_middleware()</span></code></a>, and
<a class="reference internal" href="../../../ref/utils/#django.utils.decorators.sync_and_async_middleware" title="django.utils.decorators.sync_and_async_middleware"><code class="xref py py-func docutils literal notranslate"><span class="pre">sync_and_async_middleware()</span></code></a> decorators that
allow you to apply these flags to middleware factory functions.</p>
<p>The returned callable must match the sync or async nature of the
<code class="docutils literal notranslate"><span class="pre">get_response</span></code> method. If you have an asynchronous <code class="docutils literal notranslate"><span class="pre">get_response</span></code>, you must
return a coroutine function (<code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">def</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">process_view</span></code>, <code class="docutils literal notranslate"><span class="pre">process_template_response</span></code> and <code class="docutils literal notranslate"><span class="pre">process_exception</span></code>
methods, if they are provided, should also be adapted to match the sync/async
mode. However, Django will individually adapt them as required if you do not,
at an additional performance penalty.</p>
<p>Here’s an example of how to create a middleware function that supports both:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">asgiref.sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">iscoroutinefunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">sync_and_async_middleware</span>


<span class="nd">@sync_and_async_middleware</span>
<span class="k">def</span><span class="w"> </span><span class="nf">simple_middleware</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>
    <span class="c1"># One-time configuration and initialization goes here.</span>
    <span class="k">if</span> <span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">get_response</span><span class="p">):</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="c1"># Do something here!</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">middleware</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="c1"># Do something here!</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">return</span> <span class="n">middleware</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you declare a hybrid middleware that supports both synchronous and
asynchronous calls, the kind of call you get may not match the underlying
view. Django will optimize the middleware call stack to have as few
sync/async transitions as possible.</p>
<p>Thus, even if you are wrapping an async view, you may be called in sync
mode if there is other, synchronous middleware between you and the view.</p>
</div>
<p>When using an asynchronous class-based middleware, you must ensure that
instances are correctly marked as coroutine functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">asgiref.sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">iscoroutinefunction</span><span class="p">,</span> <span class="n">markcoroutinefunction</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AsyncMiddleware</span><span class="p">:</span>
    <span class="n">async_capable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">sync_capable</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="k">if</span> <span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">):</span>
            <span class="n">markcoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># Some logic ...</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</section>
<section id="s-upgrading-pre-django-1-10-style-middleware">
<span id="s-upgrading-middleware"></span><span id="upgrading-pre-django-1-10-style-middleware"></span><span id="upgrading-middleware"></span><h2>Upgrading pre-Django 1.10-style middleware<a class="headerlink" href="#upgrading-pre-django-1-10-style-middleware" title="Link to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="django.utils.deprecation.MiddlewareMixin">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">django.utils.deprecation.</span></span><span class="sig-name descname"><span class="pre">MiddlewareMixin</span></span><a class="headerlink" href="#django.utils.deprecation.MiddlewareMixin" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>Django provides <code class="docutils literal notranslate"><span class="pre">django.utils.deprecation.MiddlewareMixin</span></code> to ease creating
middleware classes that are compatible with both <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> and the
old <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>, and support synchronous and asynchronous requests.
All middleware classes included with Django are compatible with both settings.</p>
<p>The mixin provides an <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method that requires a <code class="docutils literal notranslate"><span class="pre">get_response</span></code>
argument and stores it in <code class="docutils literal notranslate"><span class="pre">self.get_response</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method:</p>
<ol class="arabic simple">
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">self.process_request(request)</span></code> (if defined).</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">self.get_response(request)</span></code> to get the response from later
middleware and the view.</p></li>
<li><p>Calls <code class="docutils literal notranslate"><span class="pre">self.process_response(request,</span> <span class="pre">response)</span></code> (if defined).</p></li>
<li><p>Returns the response.</p></li>
</ol>
<p>If used with <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>, the <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method will
never be used; Django calls <code class="docutils literal notranslate"><span class="pre">process_request()</span></code> and <code class="docutils literal notranslate"><span class="pre">process_response()</span></code>
directly.</p>
<p>In most cases, inheriting from this mixin will be sufficient to make an
old-style middleware compatible with the new system with sufficient
backwards-compatibility. The new short-circuiting semantics will be harmless or
even beneficial to the existing middleware. In a few cases, a middleware class
may need some changes to adjust to the new semantics.</p>
<p>These are the behavioral differences between using <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> and
<code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>:</p>
<ol class="arabic simple">
<li><p>Under <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>, every middleware will always have its
<code class="docutils literal notranslate"><span class="pre">process_response</span></code> method called, even if an earlier middleware
short-circuited by returning a response from its <code class="docutils literal notranslate"><span class="pre">process_request</span></code>
method. Under <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>, middleware behaves more like an onion:
the layers that a response goes through on the way out are the same layers
that saw the request on the way in. If a middleware short-circuits, only
that middleware and the ones before it in <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> will see the
response.</p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>, <code class="docutils literal notranslate"><span class="pre">process_exception</span></code> is applied to
exceptions raised from a middleware <code class="docutils literal notranslate"><span class="pre">process_request</span></code> method. Under
<a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>, <code class="docutils literal notranslate"><span class="pre">process_exception</span></code> applies only to exceptions
raised from the view (or from the <code class="docutils literal notranslate"><span class="pre">render</span></code> method of a
<a class="reference internal" href="../../../ref/template-response/#django.template.response.TemplateResponse" title="django.template.response.TemplateResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">TemplateResponse</span></code></a>). Exceptions raised from
a middleware are converted to the appropriate HTTP response and then passed
to the next middleware.</p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">MIDDLEWARE_CLASSES</span></code>, if a <code class="docutils literal notranslate"><span class="pre">process_response</span></code> method raises
an exception, the <code class="docutils literal notranslate"><span class="pre">process_response</span></code> methods of all earlier middleware are
skipped and a <code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code> HTTP response is always
returned (even if the exception raised was e.g. an
<a class="reference internal" href="../views/#django.http.Http404" title="django.http.Http404"><code class="xref py py-class docutils literal notranslate"><span class="pre">Http404</span></code></a>). Under <a class="reference internal" href="../../../ref/settings/#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a>, an exception
raised from a middleware will immediately be converted to the appropriate
HTTP response, and then the next middleware in line will see that
response. Middleware are never skipped due to a middleware raising an
exception.</p></li>
</ol>
</section>
</section>

    </article>
  

  
    <nav class="browse-horizontal" aria-labelledby="browse-horizontal-header">
      <span id="browse-horizontal-header" class="visuallyhidden">Previous page and next page</span>
      
        <div class="left"><a rel="prev" href="../generic-views/"><i class="icon icon-chevron-left"></i> Generic views</a></div>
      
      
        <div class="right"><a rel="next" href="../sessions/">How to use sessions <i class="icon icon-chevron-right"></i></a></div>
      
    </nav>
  


        <a href="#top" class="backtotop"><i class="icon icon-chevron-up"></i> Back to Top</a>
      </main>

      
  <div role="complementary">
    <h2 class="visuallyhidden" id="aside-header">Additional Information</h2>

    


  <div class="fundraising-sidebar">
    <h3>Support Django!</h3>

    <div class="small-heart">
      <img src="https://static.djangoproject.com/img/fundraising-heart.cd6bb84ffd33.svg" alt="Support Django!" />
    </div>

    <div class="small-cta">
      <ul class="list-links-small">
        <li><a href="https://www.djangoproject.com/fundraising/">
          Anurag Panda donated to the Django Software Foundation to support Django development. Donate today!
        </a></li>
      </ul>
    </div>
  </div>



    
      <h3>Contents</h3>
      
        <ul>
<li><a class="reference internal" href="#">Middleware</a><ul>
<li><a class="reference internal" href="#writing-your-own-middleware">Writing your own middleware</a><ul>
<li><a class="reference internal" href="#init-get-response"><code class="docutils literal notranslate"><span class="pre">__init__(get_response)</span></code></a></li>
<li><a class="reference internal" href="#marking-middleware-as-unused">Marking middleware as unused</a></li>
</ul>
</li>
<li><a class="reference internal" href="#activating-middleware">Activating middleware</a></li>
<li><a class="reference internal" href="#middleware-order-and-layering">Middleware order and layering</a></li>
<li><a class="reference internal" href="#other-middleware-hooks">Other middleware hooks</a><ul>
<li><a class="reference internal" href="#process-view"><code class="docutils literal notranslate"><span class="pre">process_view()</span></code></a></li>
<li><a class="reference internal" href="#process-exception"><code class="docutils literal notranslate"><span class="pre">process_exception()</span></code></a></li>
<li><a class="reference internal" href="#process-template-response"><code class="docutils literal notranslate"><span class="pre">process_template_response()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#dealing-with-streaming-responses">Dealing with streaming responses</a></li>
<li><a class="reference internal" href="#exception-handling">Exception handling</a></li>
<li><a class="reference internal" href="#asynchronous-support">Asynchronous support</a></li>
<li><a class="reference internal" href="#upgrading-pre-django-1-10-style-middleware">Upgrading pre-Django 1.10-style middleware</a></li>
</ul>
</li>
</ul>

      
    

    
      <nav aria-labelledby="browse-header">
        <h3 id="browse-header">Browse</h3>
        <ul>
          
            
              <li>Prev: <a rel="prev" href="../generic-views/">Generic views</a></li>
            
            
              <li>Next: <a rel="next" href="../sessions/">How to use sessions</a></li>
            
            <li><a href="https://docs.djangoproject.com/en/6.0/contents/">Table of contents</a></li>
            
              <li><a href="https://docs.djangoproject.com/en/6.0/genindex/">General Index</a></li>
            
              <li><a href="https://docs.djangoproject.com/en/6.0/py-modindex/">Python Module Index</a></li>
            
          
        </ul>
      </nav>
    

    
      <nav aria-labelledby="breadcrumbs-header">
        <h3 id="breadcrumbs-header">You are here:</h3>
        <ul>
          <li>
            <a href="https://docs.djangoproject.com/en/6.0/">Django 6.0 documentation</a>
            
              <ul><li><a href="../../">Using Django</a>
            
              <ul><li><a href="../">Handling HTTP requests</a>
            
            <ul><li>Middleware</li></ul>
            </li></ul></li></ul>
          </li>
        </ul>
      </nav>
    

    
      <section aria-labelledby="getting-help-sidebar">
        <h3 id="getting-help-sidebar">Getting help</h3>
        <dl class="list-links">
          <dt><a href="https://docs.djangoproject.com/en/6.0/faq/">FAQ</a></dt>
          <dd>Try the FAQ — it's got answers to many common questions.</dd>

          <dt><a href="/en/stable/genindex/">Index</a>, <a href="/en/stable/py-modindex/">Module Index</a>, or <a href="/en/stable/contents/">Table of Contents</a></dt>
          <dd>Handy when looking for specific information.</dd>

          <dt><a href="https://chat.djangoproject.com">Django Discord Server</a></dt>
          <dd>Join the Django Discord Community.</dd>

          <dt><a href="https://forum.djangoproject.com/">Official Django Forum</a></dt>
          <dd>Join the community on the Django Forum.</dd>

          <dt><a href="https://code.djangoproject.com/">Ticket tracker</a></dt>
          <dd>Report bugs with Django or Django documentation in our ticket tracker.</dd>
        </dl>
      </section>
    

    
      <section aria-labelledby="links-wrapper-header">
        <h3 id="links-wrapper-header">Download:</h3>
        <p>
          Offline (Django 6.0):
          <a href="https://media.djangoproject.com/docs/django-docs-6.0-en.zip">HTML</a> |
          <a href="https://media.readthedocs.org/pdf/django/6.0.x/django.pdf">PDF</a> |
          <a href="https://media.readthedocs.org/epub/django/6.0.x/django.epub">ePub</a>
          <br>
          <span class="quiet">
            Provided by <a href="https://readthedocs.org/">Read the Docs</a>.
          </span>
        </p>
      </section>
    

    
  <div class="corporate-members">
    <h3>Diamond and Platinum Members</h3>
    
      <div class="clearfix">
        <div class="member-logo">
          <a href="https://sentry.io/for/django/" title="Sentry">
            <img src="https://media.djangoproject.com/cache/7a/f9/7af9c770dc49465739a82c91a0eb3d51.png" alt="Sentry" />
          </a>
        </div>
        <div class="small-cta">
          <ul class="list-links-small">
            <li><strong>Sentry</strong></li>
            <li><a href="https://sentry.io/for/django/" title="Sentry">
              Monitor your Django Code
Resolve performance bottlenecks and errors using monitoring, replays, logs and Seer an AI agent for debugging.
            </a></li>
          </ul>
        </div>
      </div>
    
      <div class="clearfix">
        <div class="member-logo">
          <a href="https://jb.gg/ybja10" title="JetBrains">
            <img src="https://media.djangoproject.com/cache/c0/ea/c0ea128467983e64aab91cd27e7918c0.png" alt="JetBrains" />
          </a>
        </div>
        <div class="small-cta">
          <ul class="list-links-small">
            <li><strong>JetBrains</strong></li>
            <li><a href="https://jb.gg/ybja10" title="JetBrains">
              JetBrains delivers intelligent software solutions that make developers more productive by simplifying their challenging tasks, automating the routine, and helping them adopt the best development practices. PyCharm is the Python IDE for Professional Developers by JetBrains providing a complete set of tools for productive Python, Web and scientific development.
            </a></li>
          </ul>
        </div>
      </div>
    
  </div>


  </div>

      

    </div>

     
     

    
    
    

    <!-- SVGs -->
    <svg xmlns="http://www.w3.org/2000/svg">
      <symbol viewBox="0 0 24 24" id="icon-auto"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2V4a8 8 0 1 0 0 16z"/></symbol>
      <symbol viewBox="0 0 24 24" id="icon-moon"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol>
      <symbol viewBox="0 0 24 24" id="icon-sun"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol>
    </svg>
    <!-- END SVGs -->

    
      

<footer>
  <div class="subfooter">
    <div class="container">
      <h2 class="visuallyhidden">Django Links</h2>
      <div class="column-container">
        <div class="col-learn-more">
          <h3>Learn More</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/start/overview/">About Django</a></li>
            
            <li><a href="https://www.djangoproject.com/start/">Getting Started with Django</a></li>
            <li><a href="https://www.djangoproject.com/foundation/teams/">Team Organization</a></li>
            <li><a href="https://www.djangoproject.com/foundation/">Django Software Foundation</a></li>
            <li><a href="https://www.djangoproject.com/conduct/">Code of Conduct</a></li>
            <li><a href="https://www.djangoproject.com/diversity/">Diversity Statement</a></li>
          </ul>
        </div>

        <div class="col-get-involved">
          <h3>Get Involved</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/community/">Join a Group</a></li>
            <li><a href="https://docs.djangoproject.com/en/dev/internals/contributing/">Contribute
              to Django</a></li>
            <li><a
              href="https://docs.djangoproject.com/en/dev/internals/contributing/bugs-and-features/">Submit
              a Bug</a></li>
            <li><a
              href="https://docs.djangoproject.com/en/dev/internals/security/#reporting-security-issues">Report
              a Security Issue</a></li>
            <li><a href="https://www.djangoproject.com/foundation/individual-members/">Individual membership</a></li>
          </ul>
        </div>

        <div class="col-get-help">
          <h3>Get Help</h3>
          <ul>
            <li><a href="https://docs.djangoproject.com/en/stable/faq/">Getting Help FAQ</a>
            </li>
            <li><a href="https://chat.djangoproject.com" target="_blank">Django Discord</a></li>
            <li><a href="https://forum.djangoproject.com/" target="_blank">Official Django Forum</a></li>
          </ul>
        </div>

        <div class="col-follow-us">
          <h3>Follow Us</h3>
          <ul>
            <li><a href="https://github.com/django">GitHub</a></li>
            <li><a href="https://x.com/djangoproject">X</a></li>
            <li><a href="https://fosstodon.org/@django" rel="me">Fediverse (Mastodon)</a></li>
            <li><a href="https://bsky.app/profile/djangoproject.com">Bluesky</a></li>
            <li><a href="https://www.linkedin.com/company/django-software-foundation">LinkedIn</a></li>
            <li><a href="https://www.djangoproject.com/rss/weblog/">News RSS</a></li>
          </ul>
        </div>

        <div class="col-support-us">
          <h3>Support Us</h3>
          <ul>
            <li><a href="https://www.djangoproject.com/fundraising/">Sponsor Django</a></li>
            <li><a href="https://www.djangoproject.com/foundation/corporate-membership/">Corporate membership</a></li>
            <li><a href="https://django.threadless.com/" target="_blank">Official merchandise store</a></li>
            <li><a href="https://www.djangoproject.com/foundation/donate/#benevity-giving">Benevity Workplace Giving Program</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="container">
      <div class="footer-logo">
        <a class="logo" href="https://www.djangoproject.com/">Django</a>
      </div>
      <ul class="thanks">
        <li>
          <span>Hosting by</span> <a class="in-kind-donors" href="https://www.djangoproject.com/fundraising/#in-kind-donors">In-kind
            donors</a>
        </li>
        <li class="design"><span>Design by</span> <a class="threespot" href="https://www.threespot.com">Threespot</a>
          <span class="ampersand">&amp;</span> <a class="andrevv" href="http://andrevv.com/">andrevv</a></li>
      </ul>
      <p class="copyright">&copy; 2005-2025
        <a href="https://www.djangoproject.com/foundation/"> Django Software
          Foundation</a> and individual contributors. Django is a
        <a href="https://www.djangoproject.com/trademarks/">registered
          trademark</a> of the Django Software Foundation.
      </p>
    </div>
  </div>

</footer>

    

    
  


    
      
      <script>
        function extless(input) {
          return input.replace(/(.*)\.[^.]+$/, '$1');
        }
        var require = {
          shim: {
            'jquery': [],
            'stripe': {
              exports: 'Stripe'
            }
          },
          paths: {
            "jquery": extless("https://static.djangoproject.com/js/lib/jquery.min.5790ead7ad3b.js"),
            "mod/list-collapsing": extless("https://static.djangoproject.com/js/mod/list-collapsing.2d844151b2ec.js"),
            "mod/stripe-change-card": extless("https://static.djangoproject.com/js/mod/stripe-change-card.eaa0afc324e9.js"),
            "mod/switch-dark-mode": extless("https://static.djangoproject.com/js/mod/switch-dark-mode.139625c684db.js"),
            "stripe-checkout": "https://checkout.stripe.com/checkout",
            "stripe": "https://js.stripe.com/v3/?" // ? needed due to require.js
          }
        };
      </script>
      <script data-main="https://static.djangoproject.com/js/main.8677b21133eb.js" src="https://static.djangoproject.com/js/lib/require.177879fbe7dd.js"></script>
      <script src="https://static.djangoproject.com/js/djangoproject.15c016c8c3a7.js"></script>
    
  </body>
</html>
